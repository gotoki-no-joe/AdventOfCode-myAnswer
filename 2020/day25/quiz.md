# 25日目:コンボブレーカー

ついにチェックインデスクに到着しました。
残念ながら、彼らの登録(registration)システムは現在オフラインであり、あなたをチェックインすることはできません。
あなたの表情に気づいた彼らは、技術サポートがすでに進行中であることをすぐに付け加えました！
彼らは今朝、全ての部屋の鍵を作成しました。
登録システムがオンラインに戻ったら、あなたはすぐに自分の鍵を持ち、部屋の保証金を渡すことができます。

ルームキーは小型のRFIDカードです。
あなたの部屋は25階にあり、エレベーターも一時的に使えないので、
階段を上ったりホールを移動したりするだけでも、あなたに残されたわずかなエネルギーが奪われます。
ようやく部屋のドアにたどり着き、カードを読み取り機にかけると、**ブー**、ライトが赤に変わりました。

カードを詳しく調べると、テクニカルサポートの電話番号を見つけました。

「こんにちは！今日はどうされましたか？」あなたは状況を説明します。

「えーと、カードがドアのロックを解除するための正しい命令を送っていないようです。
あなたがチェックインデスクに戻れば、そこにいる誰かがあなたのためにそれをリセットできるはずです。」
まだ息を切らせながら、あなたはエレベーターの状態と、あなたが今しがた登らなければならなかった階段の階数を説明しました。

「なるほど！さて、他の唯一の選択肢は、カードがドアに対して行う暗号ハンドシェイクをリバースエンジニアリングし、
独自のコマンドをデータストリームに注入することですが、それは絶対に不可能です。」
あなたは彼らに丁寧にお礼を述べました。
<!-- You thank them for their time. → Thank you for your time. 時間を割いていただき、ありがとうございます。-->

ドアにとっては不幸なことに、あなたは暗号ハンドシェイクについて少し知識があります。

カードとドアが使用するハンドシェイクには、**サブジェクト番号(subject number)を変換**する操作が含まれます。
サブジェクト番号を変換するには、値1から開始します。
次に、**ループサイズ**と呼ばれる回数、次の手順を実行します。

- 値をそれ自体に**サブジェクト番号**を掛けた値に設定します。
- 値を**20201227**で割った余りに設定します。

カードは、サブジェクト番号を変換するときに、常に特定の秘密の**ループサイズ**を使用します。
ドアは常に、異なる秘密のループサイズを使用します。

暗号化ハンドシェークは次のように動作します：

- **カード**は、カードの秘密のループサイズに従って、対象番号7を変換します。
結果は**カードの公開鍵**と呼ばれます。
- **ドア**は、ドアの秘密のループサイズに従って、対象番号7を変換します。
結果は、**ドアの公開鍵**と呼ばれます。
- カードとドアは、ワイヤレスRFID信号を使用して、2つの公開鍵（パズルの入力）をもう一方のデバイスに送信します。
これで、**カード**は**ドア**の公開鍵を持ち、**ドア**は**カード**の公開鍵を持ちます。
あなたは信号を盗聴できるので、両方の公開鍵を持っていますが、どちらのデバイスのループサイズも持っていません。
- **カード**は、カードのループサイズに従って、**ドアの公開鍵**のサブジェクト番号を変換します。
その結果が**暗号化キー**です。
- **ドア**は、ドアのループサイズに従って、**カードの公開鍵**のサブジェクト番号を変換します。
結果は、カードが計算したものと同じ**暗号化キー**です。

2つの公開鍵を使用して各デバイスのループサイズを決定できれば、
カードとドアが通信に使用する秘密の**暗号化キー**を計算するのに十分な情報が得られます。
これにより、ロック解除コマンドをドアに直接送信できます。

例えば、カードの公開キーが`5764801`であることがわかっているとします。
少し試行錯誤すれば、最初のサブジェクト番号7をループサイズ8で変換すると5764801が生成されるため、
カードのループサイズは8に違いないことがわかります。

次に、ドアの公開鍵が`17807724`であることがわかっているとします。
同じプロセスで、ドアのループサイズが11であることを確認できます。
これは、最初のサブジェクト番号7をループサイズ11で変換すると、17807724が生成されるためです。

この時点で、いずれかのデバイスのループサイズともう一方のデバイスの公開キーを使用して、暗号化キーを計算できます。
サブジェクト番号`17807724`（ドアの公開キー）をループサイズ8（カードのループサイズ）で変換すると、
暗号化キー`14897079`が生成されます。
（サブジェクト番号`5764801`（カードの公開キー）をループサイズ11（ドアのループサイズ）で変換すると、
同じ暗号化キー`14897079`が生成されます。）

ハンドシェイクで確立しようとしている暗号化キーは何ですか？

# パート2

ライトが緑色に変わり、ドアのロックが解除されます。
あなたが部屋のベッドに倒れると、ポケットベルが鳴ります！

「緊急事態です！」と、あなたを呼ぶ妖精は説明します。
「地下7階のカフェテリアにあるソフトクリームマシンが故障しました！
修理方法を知っているのはあなただけです！
既にあなたを迎えにトナカイをそちらに派遣しています。」

バルコニーに蹄が着地する音が聞こえます。

トナカイはあなたの部屋の内容を注意深く探索し、
あなたが出発する前にリゾートに支払うべき50の星をどのように支払うかを考えます。
あなたが心配しているように見えることに気づいて、トナカイはあなたにゆっくり近づきます。
あなたはトナカイが小袋を持っているのに気づきました。

袋の中には「お手数をおかけして申し訳ありません」と書かれています。
袋の底には、ヒトデの小さな絵が描かれた金貨が入っていました。

結局のところ、必要な星は49個だけのようです。

## 足りないとき

しかし、あなたは保証金を支払うのに十分なスターを持っていません。 あとxx枚必要です。

## 足りたとき
