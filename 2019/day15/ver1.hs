{-
設定だと、一つのロボットを大事に使いまわししてゴールを発見するべきなのだが、
幅優先探索をして、それぞれの経路に対してリセットされたロボットを再スタートさせるという
プログラミングならではのアプローチをとる。

それぞれの地点に到達する最短手順の長さを記憶しておく。
それより遅かったやり方は却下すればよい。

初期の生きている状態は、
コマンド[]で、位置(0,0)に、長さ0で到達した。
知っている地点は(0,0)のみ。から開始する

生きている状態それぞれについて、
さらにNESWに1歩進むコマンドを（別々に）やってみる。
壁に当たった方向は却下し、そこは壁だと記憶する。（必要）
道か目的地だった場合は移動位置と記憶する。
そもそも既に到達している地点か壁だと知っている地点への移動コマンドは却下する。
目的地に到達しているものがいたらそれで終了。
誰もいなければ、生き残った状態を次に処理するためにキューに入れる。

生成とテストのタイミングがちょっと異なっている。
-}

import qualified Data.IntMap as IM
import qualified Data.Map as M
import qualified Data.Set as S
-- import Debug.Trace

-- pc, base, memory, input, output
interpret :: Int -> Integer -> IM.IntMap Integer -> [Integer] -> [Integer]
interpret pc base mem js = case opcode of
    1 -> arith (+)
    2 -> arith (*)
    3 -> interpret (pc + 2) base (memwrite ad1 (head js)) (tail js)
    4 -> av1 : interpret (pc + 2) base mem js
    5 -> jump (av1 /= 0)
    6 -> jump (av1 == 0)
    7 -> set1 (av1 <  av2)
    8 -> set1 (av1 == av2)
    9 -> interpret (pc + 2) (base + av1) mem js
    99 -> []
    x -> error (unwords ["Illegal Opcode", show pc, show x])
  where
    opint = mem IM.! pc
    opcode = opint `mod` 100
    am1 = opint `div`   100 `mod` 10
    am2 = opint `div`  1000 `mod` 10
    am3 = opint `div` 10000 `mod` 10
    ma a = IM.findWithDefault 0 (fromIntegral a) mem
    av am ofs = (if am == 1 then id else ma) $ ad am ofs
    ad am ofs = (if am == 2 then (base +) else id) (ma $ pc + ofs)
    av1 = av am1 1
    ad1 = ad am1 1
    av2 = av am2 2
    ad3 = ad am3 3
    arith op = interpret (pc + 4) base (memwrite ad3 (op av1 av2)) js
    jump True  = interpret (fromIntegral av2) base mem js
    jump False = interpret (pc + 3) base mem js
    set1 b = interpret (pc + 4) base (memwrite ad3 (if b then 1 else 0)) js
    memwrite ad v = IM.insert (fromIntegral ad) v mem

-- type AreaMap = M.Map (Int,Int) Integer

main1 = do
    li <- readFile "input.txt"
    let ia = IM.fromList $ zip [0..] $ read $ '[' : li ++ "]"
    let ans = compute ia
--    print ans
    visualmap ans
    print $ length $ snd ans

compute :: IM.IntMap Integer -> (M.Map (Int,Int) Integer, [Integer])
compute ia = loop M.empty [((0,0),[])]
  where
    run [] = 1 -- スタート地点はゴールでない（し壁でもない）と仮定
    run ins = (!! (length ins - 1)) $ interpret 0 0 ia ins
    loop amap (((x,y),cmd):sts)
--      | trace (show $ M.size amap) False = undefined
      | M.member (x,y) amap = loop amap sts
      | result == 0 = loop amap1 sts
      | result == 1 = loop amap1 (sts ++ [north,south,west,east]) -- BFS
      | result == 2 = (amap1, cmd)
      where
        result = run cmd
        amap1 = M.insert (x,y) result amap
        north = ((x,y-1), cmd ++ [1])
        south = ((x,y+1), cmd ++ [2])
        west  = ((x-1,y), cmd ++ [3])
        east  = ((x+1,y), cmd ++ [4])

-- 地図を表示しよう。

visualmap a = putStrLn vm
  where
    m = fst a
    ps = M.keys m
    (xs,ys) = unzip ps
    xl = minimum xs
    xu = maximum xs
    yl = minimum ys
    yu = maximum ys
    vm = unlines [ [ vis (x,y) | x <- [xl..xu] ] | y <- [yl..yu] ]
    vis (0,0) = 'S'
    vis p
      | M.notMember p m = ' '
      | otherwise = case m M.! p of
          0 -> '#'
          1 -> '.'
          2 -> 'O'

{-
*Main> main1
(fromList [((-21,-20),0),((-21,-19),0),((-21,-18),0),((-21,-17),0),((-21,-16),0),((-21,-14),0),((-21,-13),0),((-21,-12),0),((-21,-10),0),((-21,-9),0),((-21,-8),0),((-21,-7),0),((-21,-6),0),((-21,-4),0),((-21,-3),0),((-21,-2),0),((-21,-1),0),((-21,0),0),((-21,1),0),((-21,2),0),((-21,3),0),((-21,4),0),((-21,5),0),((-21,6),0),((-21,7),0),((-21,8),0),((-21,9),0),((-21,10),0),((-21,12),0),((-21,13),0),((-21,14),0),((-21,16),0),((-21,17),0),((-21,18),0),((-20,-21),0),((-20,-20),1),((-20,-19),1),((-20,-18),1),((-20,-17),1),((-20,-16),1),((-20,-15),0),((-20,-14),1),((-20,-13),1),((-20,-12),1),((-20,-11),0),((-20,-10),1),((-20,-9),1),((-20,-8),1),((-20,-7),1),((-20,-6),1),((-20,-5),0),((-20,-4),1),((-20,-3),1),((-20,-2),1),((-20,-1),1),((-20,0),1),((-20,1),1),((-20,2),1),((-20,3),1),((-20,4),1),((-20,5),1),((-20,6),1),((-20,7),1),((-20,8),1),((-20,9),1),((-20,10),1),((-20,11),0),((-20,12),1),((-20,13),1),((-20,14),1),((-20,15),0),((-20,16),1),((-20,17),1),((-20,18),1),((-20,19),0),((-19,-21),0),((-19,-20),1),((-19,-19),0),((-19,-18),0),((-19,-17),0),((-19,-16),1),((-19,-15),0),((-19,-14),1),((-19,-13),0),((-19,-12),1),((-19,-11),0),((-19,-10),0),((-19,-9),0),((-19,-8),1),((-19,-7),0),((-19,-6),1),((-19,-5),0),((-19,-4),0),((-19,-3),0),((-19,-2),0),((-19,-1),0),((-19,0),0),((-19,1),0),((-19,2),0),((-19,3),0),((-19,4),1),((-19,5),0),((-19,6),0),((-19,7),0),((-19,8),0),((-19,9),0),((-19,10),1),((-19,11),0),((-19,12),1),((-19,13),0),((-19,14),1),((-19,15),0),((-19,16),1),((-19,17),0),((-19,18),1),((-19,19),0),((-18,-21),0),((-18,-20),1),((-18,-19),1),((-18,-18),1),((-18,-17),0),((-18,-16),1),((-18,-15),1),((-18,-14),1),((-18,-13),0),((-18,-12),1),((-18,-11),0),((-18,-10),1),((-18,-9),1),((-18,-8),1),((-18,-7),0),((-18,-6),1),((-18,-5),0),((-18,-4),1),((-18,-3),1),((-18,-2),1),((-18,-1),1),((-18,0),1),((-18,1),0),((-18,2),1),((-18,3),1),((-18,4),1),((-18,5),0),((-18,6),1),((-18,7),1),((-18,8),1),((-18,9),0),((-18,10),1),((-18,11),0),((-18,12),1),((-18,13),0),((-18,14),1),((-18,15),1),((-18,16),1),((-18,17),0),((-18,18),1),((-18,19),0),((-17,-20),0),((-17,-19),0),((-17,-18),1),((-17,-17),0),((-17,-16),0),((-17,-15),0),((-17,-14),0),((-17,-13),0),((-17,-12),1),((-17,-11),0),((-17,-10),1),((-17,-9),0),((-17,-8),0),((-17,-7),0),((-17,-6),1),((-17,-5),0),((-17,-4),1),((-17,-3),0),((-17,-2),0),((-17,-1),0),((-17,0),1),((-17,1),0),((-17,2),1),((-17,3),0),((-17,4),0),((-17,5),0),((-17,6),0),((-17,7),0),((-17,8),1),((-17,9),0),((-17,10),1),((-17,11),0),((-17,12),1),((-17,13),0),((-17,14),0),((-17,15),0),((-17,16),0),((-17,17),0),((-17,18),1),((-17,19),0),((-16,-21),0),((-16,-20),1),((-16,-19),1),((-16,-18),1),((-16,-17),0),((-16,-16),1),((-16,-15),1),((-16,-14),1),((-16,-13),1),((-16,-12),1),((-16,-11),1),((-16,-10),1),((-16,-9),0),((-16,-8),1),((-16,-7),1),((-16,-6),1),((-16,-5),1),((-16,-4),1),((-16,-3),0),((-16,-2),1),((-16,-1),1),((-16,0),1),((-16,1),0),((-16,2),1),((-16,3),1),((-16,4),1),((-16,5),1),((-16,6),1),((-16,7),0),((-16,8),1),((-16,9),0),((-16,10),1),((-16,11),0),((-16,12),1),((-16,13),0),((-16,14),1),((-16,15),1),((-16,16),1),((-16,17),1),((-16,18),1),((-16,19),0),((-15,-21),0),((-15,-20),1),((-15,-19),0),((-15,-18),0),((-15,-17),0),((-15,-16),1),((-15,-15),0),((-15,-14),0),((-15,-13),0),((-15,-12),0),((-15,-11),0),((-15,-10),0),((-15,-9),0),((-15,-8),1),((-15,-7),0),((-15,-6),0),((-15,-5),0),((-15,-4),0),((-15,-3),0),((-15,-2),0),((-15,-1),0),((-15,0),1),((-15,1),0),((-15,2),1),((-15,3),0),((-15,4),0),((-15,5),0),((-15,6),1),((-15,7),0),((-15,8),1),((-15,9),0),((-15,10),1),((-15,11),0),((-15,12),1),((-15,13),0),((-15,14),0),((-15,15),0),((-15,16),0),((-15,17),0),((-15,18),0),((-14,-21),0),((-14,-20),1),((-14,-19),0),((-14,-18),1),((-14,-17),1),((-14,-16),1),((-14,-15),0),((-14,-14),1),((-14,-13),1),((-14,-12),1),((-14,-11),1),((-14,-10),1),((-14,-9),0),((-14,-8),1),((-14,-7),0),((-14,-6),1),((-14,-5),1),((-14,-4),1),((-14,-3),1),((-14,-2),1),((-14,-1),0),((-14,0),1),((-14,1),0),((-14,2),1),((-14,3),0),((-14,4),1),((-14,5),1),((-14,6),1),((-14,7),0),((-14,8),1),((-14,9),0),((-14,10),1),((-14,11),0),((-14,12),1),((-14,13),0),((-14,14),1),((-14,15),1),((-14,16),1),((-14,17),1),((-14,18),1),((-14,19),0),((-13,-21),0),((-13,-20),1),((-13,-19),0),((-13,-18),0),((-13,-17),0),((-13,-16),0),((-13,-15),0),((-13,-14),1),((-13,-13),0),((-13,-12),0),((-13,-11),0),((-13,-10),1),((-13,-9),0),((-13,-8),0),((-13,-7),0),((-13,-6),1),((-13,-5),0),((-13,-4),0),((-13,-3),0),((-13,-2),1),((-13,-1),0),((-13,0),1),((-13,1),0),((-13,2),0),((-13,3),0),((-13,4),1),((-13,5),0),((-13,6),0),((-13,7),0),((-13,8),1),((-13,9),0),((-13,10),1),((-13,11),0),((-13,12),1),((-13,13),0),((-13,14),1),((-13,15),0),((-13,16),0),((-13,17),0),((-13,18),1),((-13,19),0),((-12,-21),0),((-12,-20),1),((-12,-19),1),((-12,-18),1),((-12,-17),1),((-12,-16),1),((-12,-15),1),((-12,-14),1),((-12,-13),0),((-12,-12),1),((-12,-11),0),((-12,-10),1),((-12,-9),1),((-12,-8),1),((-12,-7),0),((-12,-6),1),((-12,-5),0),((-12,-4),1),((-12,-3),0),((-12,-2),1),((-12,-1),0),((-12,0),1),((-12,1),1),((-12,2),1),((-12,3),0),((-12,4),1),((-12,5),0),((-12,6),1),((-12,7),1),((-12,8),1),((-12,9),0),((-12,10),1),((-12,11),0),((-12,12),1),((-12,13),1),((-12,14),1),((-12,15),0),((-12,16),1),((-12,17),1),((-12,18),1),((-12,19),0),((-11,-21),0),((-11,-20),1),((-11,-19),0),((-11,-18),0),((-11,-17),0),((-11,-16),0),((-11,-15),0),((-11,-14),0),((-11,-13),0),((-11,-12),1),((-11,-11),0),((-11,-10),0),((-11,-9),0),((-11,-8),1),((-11,-7),0),((-11,-6),1),((-11,-5),0),((-11,-4),1),((-11,-3),0),((-11,-2),1),((-11,-1),0),((-11,0),0),((-11,1),0),((-11,2),1),((-11,3),0),((-11,4),1),((-11,5),0),((-11,6),0),((-11,7),0),((-11,8),1),((-11,9),0),((-11,10),1),((-11,11),0),((-11,12),0),((-11,13),0),((-11,14),1),((-11,15),0),((-11,16),1),((-11,17),0),((-11,18),0),((-10,-21),0),((-10,-20),1),((-10,-19),1),((-10,-18),1),((-10,-17),1),((-10,-16),1),((-10,-15),1),((-10,-14),1),((-10,-13),1),((-10,-12),1),((-10,-11),0),((-10,-10),1),((-10,-9),1),((-10,-8),1),((-10,-7),0),((-10,-6),1),((-10,-5),1),((-10,-4),1),((-10,-3),0),((-10,-2),1),((-10,-1),0),((-10,0),1),((-10,1),1),((-10,2),1),((-10,3),0),((-10,4),1),((-10,5),0),((-10,6),1),((-10,7),1),((-10,8),1),((-10,9),0),((-10,10),1),((-10,11),1),((-10,12),1),((-10,13),0),((-10,14),1),((-10,15),0),((-10,16),1),((-10,17),1),((-10,18),1),((-10,19),0),((-9,-20),0),((-9,-19),0),((-9,-18),0),((-9,-17),0),((-9,-16),0),((-9,-15),0),((-9,-14),0),((-9,-13),0),((-9,-12),1),((-9,-11),0),((-9,-10),1),((-9,-9),0),((-9,-8),0),((-9,-7),0),((-9,-6),1),((-9,-5),0),((-9,-4),0),((-9,-3),0),((-9,-2),1),((-9,-1),0),((-9,0),1),((-9,1),0),((-9,2),0),((-9,3),0),((-9,4),1),((-9,5),0),((-9,6),1),((-9,7),0),((-9,8),0),((-9,9),0),((-9,10),0),((-9,11),0),((-9,12),1),((-9,13),0),((-9,14),0),((-9,15),0),((-9,16),1),((-9,17),0),((-9,18),1),((-9,19),0),((-8,-21),0),((-8,-20),1),((-8,-19),1),((-8,-18),1),((-8,-17),1),((-8,-16),1),((-8,-15),0),((-8,-14),1),((-8,-13),1),((-8,-12),1),((-8,-11),0),((-8,-10),1),((-8,-9),1),((-8,-8),1),((-8,-7),0),((-8,-6),1),((-8,-5),0),((-8,-4),1),((-8,-3),1),((-8,-2),1),((-8,-1),0),((-8,0),1),((-8,1),0),((-8,2),1),((-8,3),1),((-8,4),1),((-8,5),0),((-8,6),1),((-8,7),1),((-8,8),1),((-8,9),1),((-8,10),1),((-8,11),0),((-8,12),1),((-8,13),1),((-8,14),1),((-8,15),0),((-8,16),1),((-8,17),0),((-8,18),1),((-8,19),0),((-7,-21),0),((-7,-20),1),((-7,-19),0),((-7,-18),0),((-7,-17),0),((-7,-16),0),((-7,-15),0),((-7,-14),1),((-7,-13),0),((-7,-12),0),((-7,-11),0),((-7,-10),0),((-7,-9),0),((-7,-8),1),((-7,-7),0),((-7,-6),1),((-7,-5),0),((-7,-4),1),((-7,-3),0),((-7,-2),0),((-7,-1),0),((-7,0),1),((-7,1),0),((-7,2),1),((-7,3),0),((-7,4),1),((-7,5),0),((-7,6),0),((-7,7),0),((-7,8),1),((-7,9),0),((-7,10),0),((-7,11),0),((-7,12),0),((-7,13),0),((-7,14),1),((-7,15),0),((-7,16),0),((-7,17),0),((-7,18),1),((-7,19),0),((-6,-21),0),((-6,-20),1),((-6,-19),0),((-6,-18),1),((-6,-17),1),((-6,-16),1),((-6,-15),1),((-6,-14),1),((-6,-13),1),((-6,-12),1),((-6,-11),1),((-6,-10),1),((-6,-9),0),((-6,-8),1),((-6,-7),1),((-6,-6),1),((-6,-5),0),((-6,-4),1),((-6,-3),1),((-6,-2),1),((-6,-1),0),((-6,0),1),((-6,1),0),((-6,2),1),((-6,3),0),((-6,4),1),((-6,5),1),((-6,6),1),((-6,7),0),((-6,8),1),((-6,9),1),((-6,10),1),((-6,11),1),((-6,12),1),((-6,13),1),((-6,14),1),((-6,15),1),((-6,16),1),((-6,17),1),((-6,18),1),((-6,19),0),((-5,-21),0),((-5,-20),1),((-5,-19),0),((-5,-18),1),((-5,-17),0),((-5,-16),0),((-5,-15),0),((-5,-14),0),((-5,-13),0),((-5,-12),0),((-5,-11),0),((-5,-10),0),((-5,-9),0),((-5,-8),0),((-5,-7),0),((-5,-6),0),((-5,-5),0),((-5,-4),0),((-5,-3),0),((-5,-2),1),((-5,-1),0),((-5,0),1),((-5,1),0),((-5,2),0),((-5,3),0),((-5,4),0),((-5,5),0),((-5,6),1),((-5,7),0),((-5,8),1),((-5,9),0),((-5,10),0),((-5,11),0),((-5,12),0),((-5,13),0),((-5,14),0),((-5,15),0),((-5,16),0),((-5,17),0),((-5,18),0),((-4,-21),0),((-4,-20),1),((-4,-19),0),((-4,-18),1),((-4,-17),1),((-4,-16),1),((-4,-15),0),((-4,-14),1),((-4,-13),1),((-4,-12),1),((-4,-11),1),((-4,-10),1),((-4,-9),1),((-4,-8),1),((-4,-7),1),((-4,-6),1),((-4,-5),1),((-4,-4),1),((-4,-3),1),((-4,-2),1),((-4,-1),0),((-4,0),1),((-4,1),0),((-4,2),1),((-4,3),1),((-4,4),1),((-4,5),1),((-4,6),1),((-4,7),0),((-4,8),1),((-4,9),1),((-4,10),1),((-4,11),1),((-4,12),1),((-4,13),0),((-4,14),1),((-4,15),1),((-4,16),1),((-4,17),1),((-4,18),1),((-4,19),0),((-3,-21),0),((-3,-20),1),((-3,-19),0),((-3,-18),0),((-3,-17),0),((-3,-16),1),((-3,-15),0),((-3,-14),1),((-3,-13),0),((-3,-12),0),((-3,-11),0),((-3,-10),0),((-3,-9),0),((-3,-8),0),((-3,-7),0),((-3,-6),0),((-3,-5),0),((-3,-4),0),((-3,-3),0),((-3,-2),0),((-3,-1),0),((-3,0),1),((-3,1),0),((-3,2),1),((-3,3),0),((-3,4),0),((-3,5),0),((-3,6),0),((-3,7),0),((-3,8),0),((-3,9),0),((-3,10),0),((-3,11),0),((-3,12),1),((-3,13),0),((-3,14),1),((-3,15),0),((-3,16),0),((-3,17),0),((-3,18),1),((-3,19),0),((-2,-21),0),((-2,-20),1),((-2,-19),0),((-2,-18),1),((-2,-17),1),((-2,-16),1),((-2,-15),0),((-2,-14),1),((-2,-13),0),((-2,-12),1),((-2,-11),0),((-2,-10),1),((-2,-9),1),((-2,-8),1),((-2,-7),1),((-2,-6),1),((-2,-5),1),((-2,-4),1),((-2,-3),0),((-2,-2),1),((-2,-1),1),((-2,0),1),((-2,1),1),((-2,2),1),((-2,3),0),((-2,4),1),((-2,5),1),((-2,6),1),((-2,7),1),((-2,8),1),((-2,9),1),((-2,10),1),((-2,11),1),((-2,12),1),((-2,13),0),((-2,14),1),((-2,15),0),((-2,16),1),((-2,17),0),((-2,18),1),((-2,19),0),((-1,-21),0),((-1,-20),1),((-1,-19),0),((-1,-18),1),((-1,-17),0),((-1,-16),0),((-1,-15),0),((-1,-14),1),((-1,-13),0),((-1,-12),1),((-1,-11),0),((-1,-10),1),((-1,-9),0),((-1,-8),0),((-1,-7),0),((-1,-6),0),((-1,-5),0),((-1,-4),1),((-1,-3),0),((-1,-2),1),((-1,-1),0),((-1,0),0),((-1,1),0),((-1,2),0),((-1,3),0),((-1,4),0),((-1,5),0),((-1,6),1),((-1,7),0),((-1,8),0),((-1,9),0),((-1,10),0),((-1,11),0),((-1,12),0),((-1,13),0),((-1,14),1),((-1,15),0),((-1,16),1),((-1,17),0),((-1,18),1),((-1,19),0),((0,-21),0),((0,-20),1),((0,-19),1),((0,-18),1),((0,-17),0),((0,-16),1),((0,-15),0),((0,-14),1),((0,-13),0),((0,-12),1),((0,-11),1),((0,-10),1),((0,-9),0),((0,-8),1),((0,-7),1),((0,-6),1),((0,-5),0),((0,-4),1),((0,-3),1),((0,-2),1),((0,-1),0),((0,0),1),((0,1),1),((0,2),1),((0,3),1),((0,4),1),((0,5),0),((0,6),1),((0,7),1),((0,8),1),((0,9),0),((0,10),1),((0,11),1),((0,12),1),((0,13),1),((0,14),1),((0,15),0),((0,16),1),((0,17),1),((0,18),1),((0,19),0),((1,-21),0),((1,-20),1),((1,-19),0),((1,-18),0),((1,-17),0),((1,-16),1),((1,-15),0),((1,-14),1),((1,-13),0),((1,-12),0),((1,-11),0),((1,-10),0),((1,-9),0),((1,-8),1),((1,-7),0),((1,-6),1),((1,-5),0),((1,-4),0),((1,-3),0),((1,-2),0),((1,-1),0),((1,0),0),((1,1),0),((1,2),0),((1,3),0),((1,4),1),((1,5),0),((1,6),0),((1,7),0),((1,8),0),((1,9),0),((1,10),1),((1,11),0),((1,12),0),((1,13),0),((1,14),0),((1,15),0),((1,16),1),((1,17),0),((1,18),0),((2,-21),0),((2,-20),1),((2,-19),0),((2,-18),1),((2,-17),1),((2,-16),1),((2,-15),0),((2,-14),1),((2,-13),1),((2,-12),1),((2,-11),1),((2,-10),1),((2,-9),1),((2,-8),1),((2,-7),0),((2,-6),1),((2,-5),1),((2,-4),1),((2,-3),0),((2,-2),1),((2,-1),1),((2,0),1),((2,1),1),((2,2),1),((2,3),0),((2,4),1),((2,5),1),((2,6),1),((2,7),1),((2,8),1),((2,9),1),((2,10),1),((2,11),0),((2,12),1),((2,13),1),((2,14),1),((2,15),1),((2,16),1),((2,17),0),((2,18),1),((2,19),0),((3,-21),0),((3,-20),1),((3,-19),0),((3,-18),1),((3,-17),0),((3,-16),1),((3,-15),0),((3,-14),0),((3,-13),0),((3,-12),0),((3,-11),0),((3,-10),0),((3,-9),0),((3,-8),0),((3,-7),0),((3,-6),0),((3,-5),0),((3,-4),1),((3,-3),0),((3,-2),1),((3,-1),0),((3,0),0),((3,1),0),((3,2),1),((3,3),0),((3,4),0),((3,5),0),((3,6),0),((3,7),0),((3,8),0),((3,9),0),((3,10),0),((3,11),0),((3,12),1),((3,13),0),((3,14),0),((3,15),0),((3,16),0),((3,17),0),((3,18),1),((3,19),0),((4,-21),0),((4,-20),1),((4,-19),0),((4,-18),1),((4,-17),0),((4,-16),1),((4,-15),0),((4,-14),1),((4,-13),1),((4,-12),1),((4,-11),1),((4,-10),1),((4,-9),0),((4,-8),1),((4,-7),1),((4,-6),1),((4,-5),0),((4,-4),1),((4,-3),1),((4,-2),1),((4,-1),0),((4,0),1),((4,1),0),((4,2),1),((4,3),1),((4,4),1),((4,5),1),((4,6),1),((4,7),1),((4,8),1),((4,9),1),((4,10),1),((4,11),0),((4,12),1),((4,13),0),((4,14),1),((4,15),1),((4,16),1),((4,17),1),((4,18),1),((4,19),0),((5,-21),0),((5,-20),1),((5,-19),0),((5,-18),1),((5,-17),0),((5,-16),1),((5,-15),0),((5,-14),1),((5,-13),0),((5,-12),1),((5,-11),0),((5,-10),1),((5,-9),0),((5,-8),1),((5,-7),0),((5,-6),0),((5,-4),0),((5,-3),0),((5,-2),0),((5,-1),0),((5,0),1),((5,1),0),((5,2),0),((5,3),0),((5,4),0),((5,5),0),((5,6),1),((5,7),0),((5,8),0),((5,9),0),((5,10),1),((5,11),0),((5,12),1),((5,13),0),((5,14),0),((5,15),0),((5,16),1),((5,17),0),((5,18),1),((5,19),0),((6,-21),0),((6,-20),1),((6,-19),0),((6,-18),1),((6,-17),0),((6,-16),1),((6,-15),0),((6,-14),1),((6,-13),0),((6,-12),1),((6,-11),0),((6,-10),1),((6,-9),0),((6,-8),1),((6,-7),1),((6,-6),1),((6,-5),0),((6,-4),1),((6,-3),1),((6,-2),1),((6,-1),1),((6,0),1),((6,1),1),((6,2),1),((6,3),1),((6,4),1),((6,5),0),((6,6),1),((6,7),0),((6,8),1),((6,9),1),((6,10),1),((6,11),0),((6,12),1),((6,13),1),((6,14),1),((6,15),1),((6,16),1),((6,17),0),((6,18),1),((6,19),0),((7,-21),0),((7,-20),1),((7,-19),0),((7,-18),1),((7,-17),0),((7,-16),1),((7,-15),0),((7,-14),1),((7,-13),0),((7,-12),1),((7,-11),0),((7,-10),1),((7,-9),0),((7,-8),1),((7,-7),0),((7,-6),1),((7,-5),0),((7,-4),1),((7,-3),0),((7,-2),0),((7,-1),0),((7,0),1),((7,1),0),((7,2),0),((7,3),0),((7,4),1),((7,5),0),((7,6),1),((7,7),0),((7,8),0),((7,9),0),((7,10),0),((7,12),0),((7,13),0),((7,14),0),((7,15),0),((7,16),0),((7,17),0),((7,18),1),((7,19),0),((8,-21),0),((8,-20),1),((8,-19),0),((8,-18),1),((8,-17),0),((8,-16),1),((8,-15),1),((8,-14),1),((8,-13),0),((8,-12),1),((8,-11),0),((8,-10),1),((8,-9),0),((8,-8),1),((8,-7),0),((8,-6),1),((8,-5),1),((8,-4),1),((8,-3),1),((8,-2),1),((8,-1),0),((8,0),1),((8,1),1),((8,2),1),((8,3),0),((8,4),1),((8,5),0),((8,6),1),((8,7),1),((8,8),1),((8,9),1),((8,10),1),((8,11),0),((8,12),1),((8,13),1),((8,14),1),((8,15),1),((8,16),1),((8,17),1),((8,18),1),((8,19),0),((9,-21),0),((9,-20),1),((9,-19),0),((9,-18),0),((9,-16),0),((9,-15),0),((9,-14),0),((9,-13),0),((9,-12),1),((9,-11),0),((9,-10),1),((9,-9),0),((9,-8),0),((9,-7),0),((9,-6),0),((9,-5),0),((9,-4),0),((9,-3),0),((9,-2),0),((9,-1),0),((9,0),0),((9,1),0),((9,2),1),((9,3),0),((9,4),1),((9,5),0),((9,6),0),((9,7),0),((9,8),0),((9,9),0),((9,10),1),((9,11),0),((9,12),1),((9,13),0),((9,14),0),((9,15),0),((9,16),0),((9,17),0),((9,18),0),((10,-21),0),((10,-20),1),((10,-19),1),((10,-18),1),((10,-17),0),((10,-16),1),((10,-15),1),((10,-14),1),((10,-13),0),((10,-12),1),((10,-11),0),((10,-10),1),((10,-9),1),((10,-8),1),((10,-7),1),((10,-6),1),((10,-5),1),((10,-4),1),((10,-3),0),((10,-2),1),((10,-1),1),((10,0),1),((10,1),1),((10,2),1),((10,3),0),((10,4),1),((10,5),1),((10,6),1),((10,7),1),((10,8),1),((10,9),0),((10,10),1),((10,11),1),((10,12),1),((10,13),0),((10,14),1),((10,15),1),((10,16),1),((10,17),1),((10,18),1),((10,19),0),((11,-20),0),((11,-19),0),((11,-18),1),((11,-17),0),((11,-16),1),((11,-15),0),((11,-14),1),((11,-13),0),((11,-12),1),((11,-11),0),((11,-10),0),((11,-9),0),((11,-8),0),((11,-7),0),((11,-6),0),((11,-5),0),((11,-4),1),((11,-3),0),((11,-2),1),((11,-1),0),((11,0),0),((11,1),0),((11,2),0),((11,4),0),((11,5),0),((11,6),0),((11,7),0),((11,8),1),((11,9),0),((11,10),0),((11,11),0),((11,12),0),((11,13),0),((11,14),1),((11,15),0),((11,16),0),((11,17),0),((11,18),1),((11,19),0),((12,-21),0),((12,-20),1),((12,-19),0),((12,-18),1),((12,-17),1),((12,-16),1),((12,-15),0),((12,-14),1),((12,-13),0),((12,-12),1),((12,-11),1),((12,-10),1),((12,-9),0),((12,-8),1),((12,-7),1),((12,-6),1),((12,-5),1),((12,-4),1),((12,-3),1),((12,-2),1),((12,-1),0),((12,0),1),((12,1),1),((12,2),1),((12,3),0),((12,4),1),((12,5),1),((12,6),1),((12,7),1),((12,8),1),((12,9),0),((12,10),1),((12,11),1),((12,12),1),((12,13),1),((12,14),1),((12,15),0),((12,16),1),((12,17),0),((12,18),1),((12,19),0),((13,-21),0),((13,-20),1),((13,-19),0),((13,-18),0),((13,-17),0),((13,-16),0),((13,-15),0),((13,-14),1),((13,-13),0),((13,-12),1),((13,-11),0),((13,-10),1),((13,-9),0),((13,-8),0),((13,-7),0),((13,-6),0),((13,-5),0),((13,-4),0),((13,-3),0),((13,-2),0),((13,-1),0),((13,0),1),((13,1),0),((13,2),1),((13,3),0),((13,4),1),((13,5),0),((13,6),0),((13,7),0),((13,8),0),((13,9),0),((13,10),0),((13,11),0),((13,12),1),((13,13),0),((13,14),0),((13,15),0),((13,16),1),((13,17),0),((13,18),1),((13,19),0),((14,-21),0),((14,-20),1),((14,-19),0),((14,-18),1),((14,-17),1),((14,-16),1),((14,-15),1),((14,-14),1),((14,-13),0),((14,-12),1),((14,-11),0),((14,-10),1),((14,-9),1),((14,-8),1),((14,-7),0),((14,-6),1),((14,-5),1),((14,-4),1),((14,-3),0),((14,-2),1),((14,-1),1),((14,0),1),((14,1),0),((14,2),1),((14,3),1),((14,4),1),((14,5),0),((14,6),1),((14,7),1),((14,8),1),((14,9),1),((14,10),1),((14,11),1),((14,12),1),((14,13),0),((14,14),2),((14,15),0),((14,16),1),((14,17),1),((14,18),1),((14,19),0),((15,-21),0),((15,-20),1),((15,-19),0),((15,-18),1),((15,-17),0),((15,-16),0),((15,-15),0),((15,-14),0),((15,-13),0),((15,-12),0),((15,-11),0),((15,-10),0),((15,-9),0),((15,-8),1),((15,-7),0),((15,-6),1),((15,-5),0),((15,-4),1),((15,-3),0),((15,-2),1),((15,-1),0),((15,0),0),((15,1),0),((15,2),0),((15,3),0),((15,4),0),((15,5),0),((15,6),0),((15,7),0),((15,8),1),((15,9),0),((15,10),0),((15,11),0),((15,12),0),((15,13),0),((15,14),1),((15,15),0),((15,16),1),((15,17),0),((15,18),0),((16,-21),0),((16,-20),1),((16,-19),0),((16,-18),1),((16,-17),0),((16,-16),1),((16,-15),1),((16,-14),1),((16,-13),1),((16,-12),1),((16,-11),1),((16,-10),1),((16,-9),0),((16,-8),1),((16,-7),1),((16,-6),1),((16,-5),0),((16,-4),1),((16,-3),0),((16,-2),1),((16,-1),0),((16,0),1),((16,1),1),((16,2),1),((16,3),1),((16,4),1),((16,5),1),((16,6),1),((16,7),0),((16,8),1),((16,9),0),((16,10),1),((16,11),1),((16,12),1),((16,13),1),((16,14),1),((16,15),0),((16,16),1),((16,17),1),((16,18),1),((16,19),0),((17,-21),0),((17,-20),1),((17,-19),0),((17,-18),1),((17,-17),0),((17,-16),1),((17,-15),0),((17,-14),0),((17,-13),0),((17,-12),0),((17,-11),0),((17,-10),1),((17,-9),0),((17,-8),0),((17,-7),0),((17,-6),0),((17,-5),0),((17,-4),1),((17,-3),0),((17,-2),1),((17,-1),0),((17,0),0),((17,1),0),((17,2),0),((17,3),0),((17,4),1),((17,5),0),((17,6),1),((17,7),0),((17,8),1),((17,9),0),((17,10),1),((17,11),0),((17,12),1),((17,13),0),((17,14),0),((17,15),0),((17,16),0),((17,17),0),((17,18),1),((17,19),0),((18,-21),0),((18,-20),1),((18,-19),1),((18,-18),1),((18,-17),1),((18,-16),1),((18,-15),0),((18,-14),1),((18,-13),1),((18,-12),1),((18,-11),1),((18,-10),1),((18,-9),1),((18,-8),1),((18,-7),1),((18,-6),1),((18,-5),1),((18,-4),1),((18,-3),0),((18,-2),1),((18,-1),1),((18,0),1),((18,1),1),((18,2),1),((18,3),1),((18,4),1),((18,5),0),((18,6),1),((18,7),1),((18,8),1),((18,9),0),((18,10),1),((18,11),0),((18,12),1),((18,13),1),((18,14),1),((18,15),1),((18,16),1),((18,17),1),((18,18),1),((18,19),0),((19,-20),0),((19,-19),0),((19,-18),0),((19,-17),0),((19,-16),0),((19,-14),0),((19,-13),0),((19,-12),0),((19,-11),0),((19,-10),0),((19,-9),0),((19,-8),0),((19,-7),0),((19,-6),0),((19,-5),0),((19,-4),0),((19,-2),0),((19,-1),0),((19,0),0),((19,1),0),((19,2),0),((19,3),0),((19,4),0),((19,6),0),((19,7),0),((19,8),0),((19,12),0),((19,13),0),((19,14),0),((19,15),0),((19,16),0),((19,17),0),((19,18),0)],[2,2,2,2,4,4,2,2,2,2,2,2,3,3,2,2,2,2,3,3,3,3,2,2,2,2,4,4,4,4,1,1,4,4,1,1,1,1,4,4,4,4,2,2,2,2,3,3,2,2,4,4,4,4,1,1,1,1,1,1,4,4,1,1,3,3,1,1,1,1,3,3,3,3,1,1,1,1,3,3,1,1,1,1,4,4,1,1,3,3,1,1,3,3,1,1,4,4,1,1,1,1,1,1,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,3,3,1,1,3,3,2,2,3,3,3,3,3,3,1,1,1,1,4,4,4,4,4,4,4,4,1,1,3,3,1,1,3,3,2,2,3,3,1,1,3,3,1,1,1,1,4,4,1,1,1,1,1,1,4,4,2,2,2,2,2,2,2,2,4,4,1,1,4,4,1,1,1,1,4,4,2,2,4,4,1,1,4,4,1,1,4,4,4,4,4,4,4,4,4,4,2,2,4,4,2,2,3,3,2,2,4,4,4,4,1,1,1,1,4,4,4,4,2,2,3,3,2,2,2,2,2,2,4,4,2,2,2,2,2,2,3,3,3,3,1,1,4,4,1,1,3,3,1,1,3,3,1,1,3,3,3,3,3,3,3,3,2,2,4,4,4,4,4,4,2,2,2,2,2,2,4,4,2,2,3,3,2,2,2,2,3,3,1,1,3,3,2,2,2,2,4,4,4,4,2,2,2,2,4,4,1,1,1,1,4,4,1,1,3,3,1,1,4,4,1,1,4,4,4,4,2,2,2,2,2,2,3,3,2,2,4,4,2,2,3,3,3,3,2,2,2,2,3,3,2,2,3,3,2,2,2,2,4,4,4,4,1,1,4,4,2,2,4,4,1,1,1,1,1,1,3,3,2,2,3,3])
 ### ####### ################### ####### 
#...#.......#...................#.......#
#.#.#.###.#.#.#######.#########.#######.#
#.#...#.#.#.#.#...#...#.......#...#.....#
#.#####.#.#.#.#.#.#.###.###### ##.#.###.#
#...#...#.#.#.#.#...#.........#...#.#...#
 ##.#.###.#.###.#############.#.###.#.## 
#...#.#...#.#...#.......#.....#.....#.#.#
#.###.#.###.#.#.#.#####.#.###########.#.#
#.....#.#.....#.#.#...#.#...........#.#.#
 ####.#.#######.#.###.#.#.#######.###.#.#
#.#...#...#...#.#.#...#.#.......#...#...#
#.#.#####.#.#.###.#.###.#######.###.###.#
#...#...#...#...#.#.#...#.....#.#.#...#.#
#.###.#########.#.#.#.###.#.###.#.###.#.#
#.....#.........#.#.#...#.#...#.#.#...#.#
 ####.#.###.#####.#.###.## ##.#.#.#.###.#
#.#...#.#...#...#.#...#...#...#...#.....#
#.#.###.#####.#.#.###.###.#.#.###.###### 
#.#.#.#.......#...#...#...#.#.#...#.....#
#.#.#.#############.###.###.###.###.###.#
#.#.......#.........#S#.#.....#.#...#.#.#
#.#######.#.#######.#.#.###.#.#.#.###.#.#
#.#.....#...#...#...#.#...#.#...#...#.#.#
#.#.#.#######.###.###.###.#.#### ##.#.#.#
#...#.#.........#.#.#...#.#.....#...#...#
#.###.#.#######.#.#.###.#.#####.#.###.## 
#.#.#...#.#...#...#...#.#.....#.#.#.#...#
#.#.#####.#.#.#####.#.#.#.###.#.#.#.###.#
#.#.........#.....#.#.#.#.#.#.#...#.....#
#.###########.#.#.#.###.#.#.#.#####.#### 
#...........#.#.#.#.#...#...#...#.#.#... 
 ##########.###.#.#.#.###### ##.#.#.#.## 
#.........#...#.#...#.#.....#...#...#...#
#.#######.###.#.#####.#.###.#.###.###.#.#
#...#.#.....#...#.....#.#.#.#.#...#O..#.#
 ##.#.#.#######.#.#####.#.#.#.#.#######.#
#...#.#.#.....#.#.#.....#...#.#.#.....#.#
#.###.#.#.#.###.#.###.###.###.#.###.#.#.#
#.....#...#.....#.....#.......#.....#...#
 ##### ### ##### ##### ####### ##### ### 

404
-}

-- part2
{-
・BFSで未探索空間がなくなるまで探索し尽くす。候補が消えやすいという意味でDFSのが有利かな？
・`O`と`.`だけ抜き出したマップを用意する
・`.`であって上下左右のいずれかに`O`があるものは`O`、その他は同じでマップを反復的に更新する
・`.`がなくなるまでの回数を数える
とやるだけ。あとは計算機の仕事。懐かしいPAINTだ。

いやもっと効率的にやらないとダメだ。
・`O`の位置だけがHotである。
・Hotな位置の周辺の`.`が次にHotになり、HotなものはColdになる。
・Hotなものがなくなるまで繰り返し。
-}

main2 = do
  li <- readFile "input.txt"
  let ia = IM.fromList $ zip [0..] $ read $ '[' : li ++ "]"
  let ans = compute2 ia
  print ans

compute2 :: IM.IntMap Integer -> Int
compute2 ia = paintcount (-1) start floors
  where
    run [] = 1 -- スタート地点はゴールでない（し壁でもない）と仮定
    run ins = (!! (length ins - 1)) $ interpret 0 0 ia ins
    loop amap [] = amap
    loop amap (((x,y),cmd):sts)
      | M.member (x,y) amap = loop amap sts
      | result == 0 = loop amap1 sts
      | otherwise = loop amap1 (north:west:east:south:sts) -- DFS
      where
        result = fromIntegral $ run cmd
        amap1 = M.insert (x,y) result amap
        north = ((x,y-1), cmd ++ [1])
        south = ((x,y+1), cmd ++ [2])
        west  = ((x-1,y), cmd ++ [3])
        east  = ((x+1,y), cmd ++ [4])
    themap = loop (M.empty :: M.Map (Int,Int) Int) [((0,0),[])]
    floors = S.fromList $ map fst $ filter ((1 ==).snd) $ M.assocs themap
    start = S.fromList $ map fst $ filter ((2 ==).snd) $ M.assocs themap

paintcount :: Int -> S.Set (Int,Int) -> S.Set (Int,Int) -> Int
paintcount k hot floors
  | null hot = k
  | otherwise = paintcount (succ k) hot1 (S.difference floors hot1)
  where
    hot1 = S.fromList [ h1 | h@(x,y) <- S.elems hot, h1 <- [(x-1,y),(x+1,y),(x,y-1),(x,y+1)], S.member h1 floors ]

{-
*Main> main2
406
-}