# 17日目：設定したら放置 #

早期警告システムが[太陽フレア](https://ja.wikipedia.org/wiki/%E5%A4%AA%E9%99%BD%E3%83%95%E3%83%AC%E3%82%A2)の到来を検出し、
船の電磁シールドを自動的に起動します。
残念ながら、これは、差し迫った危険に気づいていない多くの小型ロボットのWi-Fiを遮断し、
ロボットたちはシールドの安全でない側の船外足場に閉じ込められています。
彼らを救うには、すぐに行動しなければなりません！

あなたが自由に使える唯一のツールは、いくつかの有線カメラと充電ステーションで現在眠っている小さな掃除ロボットです。
ビデオの品質はよくありませんが、掃除ロボットには不必要に明るいLEDがあるため、どこにいても簡単に見つけることができます。

[Intcode](../day9/quiz.md)のプログラム「**船尾足場制御情報インタフェース**
（Aft Scaffolding Control and Information Interface, ASCII、あなたのパズル入力）は、
カメラおよび掃除ロボットへのアクセスを提供します。
現在、掃除ロボットは眠っているので、カメラにのみアクセスできます。

IntcodeコンピュータでASCIIプログラムを実行すると、足場の現在の様子が表示されます。
この出力は全くの偶然で[ASCIIコード](https://ja.wikipedia.org/wiki/ASCII)になっています。
`35`は`#`を意味し、`46`は`.`を意味し、`10`は現在の出力の下に
[新しい行](https://ja.wikipedia.org/wiki/%E6%94%B9%E8%A1%8C%E3%82%B3%E3%83%BC%E3%83%89#%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E6%94%B9%E8%A1%8C%E3%82%B3%E3%83%BC%E3%83%89)
を開始する、などです。
（行内では、文字は左から右に描かれます。）

カメラ出力で`#`は足場を表し、`.`は空地を表します。
掃除ロボットはその向きが上下左右のときそれぞれ`^`, `v`, `<`, `>`で表示されます。
このように描かれているとき、掃除ロボットは常に**足場に乗っています**。
掃除ロボットが足場から外れて**制御不能に宇宙空間に転がり出た**場合、
それは代わりに`X`で表示されます。

一般に、足場は経路を形成しますが、ループしてそれ自体と交差することもあります。
たとえば、カメラから次の表示を得たとします。

```
..#..........
..#..........
#######...###
#.#...#...#.#
#############
..#...#...#..
..#####...^..
```

ここで掃除ロボット`^`が上向きで、画像の右下近くの足場の一端に位置しています。
足場は上に伸び、何回かループし、画像の左上で終わります。

最初のステップは、いくつかの明確に定義されたポイントの**位置合わせパラメータ**を求めて、カメラを較正することです。
すべての**足場の交差**の位置を特定してください。
それぞれの交差に対して、その位置合わせパラメータは、
画像の左端から交差の左端までの間の距離に、
画像の上端から交差の上端までの間の距離を掛けたものです。
上の画像の交差を`O`で印したものを示します：

```
..#..........
..#..........
##O####...###
#.#...#...#.#
##O###O###O##
..#...#...#..
..#####...^..
```

これらの交差について：

- 左上の交差は画像の左から2単位、画像の上部から2単位の位置にあるため、位置合わせパラメータは2 * 2 = 4です。
- 左下の交差は画像の左から2単位、画像の上部から4単位の位置にあるため、位置合わせパラメータは2 * 4 = 8です。
- 中央下の交差は左から6上から4で、その位置合わせパラメータは24です。
- 右下の交差の位置合わせパラメータは40です。

カメラを較正するには**位置合わせパラメータの合計**が必要です。
上の例ではこれは**76**です。

ASCIIプログラムを実行してください。
足場の交差の**位置合わせパラメータの合計はいくつですか？**

# パート2 #

ここからが手際の必要な所です。
他のすべてのロボットに太陽フレアについて通知します。
掃除ロボットは、ロボットの範囲内に入るとこれを自動的に行うことができます。
ただし、カメラで他のロボットを見ることができないので、代わりにくまなくする必要があります。
掃除ロボットに**足場のすべての部分を少なくとも1回訪問**させる必要があります。

掃除ロボットは通常ランダムにさまよいますが、今日はそんな時間はありません。
代わりに、新しい規則で**その移動ロジックをオーバーライド**できます。

あなたのASCIIプログラムのアドレス0の値を1から2に変更することで、掃除ロボットを強制的に起動します。
これを行うと、掃除ロボットが使用する新しい移動ルールの入力を自動的に求められます。
ASCIIプログラムは入力命令を使用してそれらを受信しますが、
それはASCIIコードで提供する必要があります。
ロジックの各行は単一の改行コード、ASCIIコード10で終了します。

最初に、**メインの移動ルーチン**が要求されます。
メインルーチンは**移動関数**'A','B','C'を呼び出すことのみが行えます。
使用する移動関数をASCIIテキストにより与えます。
これはコンマ（`,` ASCIIコード44）で区切り、リストを改行（ASCIIコード10）で終了します。
たとえば、`A`を2回呼び出して`B`と`C`を3回交互に呼び出すには、
文字列`A,A,B,C,B,C,B,C`と改行を入力します。

次に、各**移動関数**が要求されます。
移動関数では、**左に曲がる**ために`L`、**右に曲がる**ために`R`、
または数字、これはその数ユニット分の**前進**を意味します、
の文字が使用できます。
移動関数から他の移動関数を呼び出すことはできません。
こちらもやはり、動作をコンマで区切り、リストを改行で終了します。
たとえば、前方に10ユニット移動し、左に曲がり、前方に8ユニット移動し、
右に曲がり、最後に前方に6ユニット移動するには、
文字列`10,L,8,R,6`と改行を入力します。

最後に**連続ビデオフィード**が必要どうかを尋ねられます。
`y`または`n`のいずれかと改行を与えます。
連続ビデオフィードを有効にすると何が起こっているかを確認できますが、
かなりの処理能力が必要になり、Intcodeコンピュータがオーバーヒートしてしまう可能性すらあります。

掃除ロボットのメモリの量が限られているため、
メインルーチンと移動関数のASCII定義は
改行を数えずにそれぞれ**最大20文字**までです。

たとえば、次のカメラフィードを考えます。

```
#######...#####
#.....#...#...#
#.....#...#...#
......#...#...#
......#...###.#
......#.....#.#
^########...#.#
......#.#...#.#
......#########
........#...#..
....#########..
....#...#......
....#...#......
....#...#......
....#####......
```

**掃除ロボットが足場のすべての部分を少なくとも1回訪問する**ために、
それが取ることができる経路のひとつは次のとおりです。

```
R,8,R,8,R,4,R,4,R,8,L,6,L,2,R,4,R,4,R,8,R,8,R,8,L,6,L,2
```

メモリの制限がなければ、この文字列全体を関数`A`に指定し、
メインルーチンは`A`を1回呼び出すだけで済みます。
しかしながら、より小さな部分に分割する必要があります。

ひとつのアプローチは次のとおりです。

- **メインルーチン： `A,B,C,B,A,C` **
（ASCII入力：65, 44, 66, 44, 67, 44, 66, 44, 65, 44, 67, 10）
- **関数`A`：`R,8,R,8` **
（ASCII入力：82, 44, 56, 44, 82, 44, 56, 10）
- **関数`B`：`R,4,R,4,R,8` **
（ASCII入力：82, 44, 52, 44, 82, 44, 52, 44, 82, 44, 56, 10）
- **関数`C`：`L,6,L,2` **
（ASCII入力：76, 44, 54, 44, 76, 44, 50, 10）

視覚的には、これは目的の経路を次の部分に分割します。

```
A,        B,            C,        B,            A,        C
R,8,R,8,  R,4,R,4,R,8,  L,6,L,2,  R,4,R,4,R,8,  R,8,R,8,  L,6,L,2

CCCCCCA...BBBBB
C.....A...B...B
C.....A...B...B
......A...B...B
......A...CCC.B
......A.....C.B
^AAAAAAAA...C.B
......A.A...C.B
......AAAAAA#AB
........A...C..
....BBBB#BBBB..
....B...A......
....B...A......
....B...A......
....BBBBA......
```

もちろん、あなたの船の外の足場はもっと複雑です。

掃除ロボットは、他のロボットを見つけて差し迫った太陽フレアを通知するとき、
見つけた宇宙塵を集めて彼らをピカピカに掃除する動作を止めることができません。
プログラムされた一連の動きが完了すると、それが宇宙に流れ出ていなければ、
掃除ロボットはドッキングステーションに戻り、
収集した宇宙塵の量を単一の出力命令で報告します。
これは大きな値でASCII文字ではありません。

足場のすべての部分を少なくとも1回訪れた後、
**掃除ロボットはどのくらいの塵を収集したと報告しますか？**
