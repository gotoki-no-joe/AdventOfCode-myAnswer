# 22日目：剰余迷路

ここが最後の目的地、-483年です。
外は雪が降っていて暗いです。
見えるのは遠くにある小さな小屋からの光だけです。
あなたはそこへ向かい、ドアをノックします。

大きな白いひげを生やした屈強な男性がドアに出て、あなたを中に招き入れます。
-483年の北極近くに住んでいる人にとって、訪問者はそれほど多くないはずですが、あなたに会っても驚いた様子はありません。
代わりに、彼はミルクとクッキーを勧めます。

しばらく話した後、彼はあなたにお願いをします。
彼の友人が数時間経っても戻ってこず、どこにいるのかもわかりません。
この地域を簡単にスキャンすると、近くの洞窟系で生命信号が1つ発見されました。
彼の友人はそこに避難したに違いありません。
男は、あなたに友人を迎えに行ってくれないかと尋ねます。

洞窟は、正方形の**領域**に分かれています。
それらは、主に**岩場**、**狭い**、**湿っている**かのいずれかです。
（これを領域の**種類**と呼びます。）
各領域は、0以上の整数X,YによりX,Yという形式で表される**座標**をちょうど一つ占めています。
（隣接する領域は種類が同じになることもあります。）

スキャン（パズルの入力）はあまり詳細ではありません。
洞窟系の**深さ**と**目標の座標**のみが明らかになります。
ただし、各領域の種類は明らかにされません。
洞窟の入り口は(0,0)にあります。

この男性は、この地域の地質が異常であるため、**浸食レベル**(erosion level)に基づいて領域の種類を判断する方法があると説明しています。
領域の浸食レベルはその**地質指数**(geologic index)から判断できます。
地質指数は、以下のリストにから最初に適用される規則を用いて決定できます。

- 0,0 （洞窟の入り口）の領域の地質指数は0です。
- 目標の座標にある領域の地質指数は0です。
- 領域のY座標が0の場合、地質指数はそのX座標の16807倍になります。
- 領域のX座標が0の場合、地質指数はそのY座標の48271倍になります。
- それ以外の場合、その領域の地質指数は、X-1,YとX,Y-1の領域の浸食**レベル**を乗算した結果になります。

領域の**浸食レベル**は、その**地質指数**に洞窟系の**深さ**を加算したもので、すべて20183を法として求めます。
そして：

- **浸食レベルのモジュロ3**が0の場合、領域の種類は**岩場**です。
- **侵食レベルのモジュロ3**が1の場合、領域の種類は**湿っている**です。
- **侵食レベルのモジュロ3**が2の場合、領域の種類は**狭い**です。

例えば、洞窟系の深さが510で、目標の座標が10,10であるとします。
モジュロ演算子を`%`で表して、洞窟は次のようになります：

- 0,0での地質指数は0です。侵食レベルは(0 + 510) % 20183 = 510です。種類は510 % 3 = 0、**岩場**です。
- 1,0では、Y座標は0であるため、地質指数は1 * 16807 = 16807です。侵食レベルは(16807 + 510) % 20183 = 17317です。種類は17317 % 3 = 1、**湿っている**です。
- 0,1では、X座標は0であるため、地質指数は1 * 48271 = 48271です。侵食レベルは(48271 + 510) % 20183 = 8415です。種類は8415 % 3 = 0、岩場です。
- 1,1では、どちらの座標も目標の座標ではないため、地質指数は0,1の浸食レベル(8415)と1,0の浸食レベル(17317)の積、8415 * 17317 = 145722555になります。侵食レベルは(145722555 + 510) % 20183 = 1805です。種類は1805 % 3 = 2、**狭い**です。
- 10,10では、それらは目標の座標であるため、地質指数は0です。侵食レベルは(0 + 510) % 20183 = 510です。種類は510 % 3 = 0、**岩場**です。

この同じ洞窟系を、岩場を`.`、濡れているを`=`、狭いを`|`、入り口を`M`、目標を`T`で、左上隅を0,0とし、右に行くほどXが増加し、下に行くほどYが増加するよう描くと、地図の左上隅は次のようになります：

```
M=.|=.|.|=.|=|=.
.|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||
```

立ち入る前に、その領域の**危険レベル**を判断する必要があります。
長方形で、領域0,0を左上隅、目標を含む領域を右下隅に持つものについて、
個々の領域の危険レベル、岩領域は0、湿った領域は1、狭い領域は2、を合計します。

上記の洞窟系では、入り口が0,0にあり、目標が10,10にあるため、
X座標が0から10まで、Y座標が0から10までの全ての領域の危険レベルを足し合わせると、この合計は**114**になります。

**0,0と目標の座標を含む最小の長方形の危険レベル合計はいくつですか？**

# パート2

さて、男の友人を救出しに行く時間です。

あなたが出発するとき、彼はあなたにいくつかの道具、**懐中電灯**と何かの**登山用具**を手渡しました。
両方の道具を同時に装備することはできませんが、**どちらも使用しない**ことは選択できます。

道具は特定の領域でのみ使用できます：

- **岩場**では、**登山用具**または**懐中電灯**を使用できます。**どちらも使用しない**ことはできません（滑って転ぶ可能性があります）。
- **湿った**領域では、**登山用具**を使用するか、どちらの道具も**使わない**かのいずれかができます。**懐中電灯**は使用できません（濡れると光源がなくなります）。
- **狭い**領域では、**懐中電灯**を使用するか、どちらの道具も**使わない**かのいずれかができます。**登山用具**は使用できません（かさばりすぎて入りません）。

あなたは0,0（洞窟の入り口）から**懐中電灯を装備**した状態で出発し、できるだけ早く目標座標に到達する必要があります。
XやYがマイナスの領域は堅い岩であり、動き回ることはできません。
最速の経路は、目標のX,Y座標を超えた領域に入ることを必要とする可能性があります。

現在装備しているツールでその領域に入ることができる場合は、隣接する領域(上下左右、決して斜めには移動しないでください) に移動できます。隣接するリージョンへの移動には1 分かかります。（例えば、たいまつを装備していれば、岩場や狭い場所は移動できますが、濡れた場所には入れません。）

現在装備しているツールを変更することも、新しい装備が現在の地域で有効である場合は両方を保管することもできます。登山用具、トーチ、またはその両方の使用に切り替えるには、どの道具から始めるかに関係なく、常に7分かかります。（たとえば、岩場にいる場合、懐中電灯から登山用具に切り替えることはできますが、どちらにも切り替えることはできません。）

最後に、ターゲットに到達したら、暗闇の中でターゲットを見つける前に懐中電灯を装備する必要があります。目標は常に岩場にあるため、登山装備を装備して到着した場合、トーチに持ち替えるまでに 7 分を費やす必要があります。

たとえば、上記と同じ洞窟システムを使用し、左上隅 ( 0,0) から開始して右下隅 (ターゲット、10,10) にできるだけ早く移動する場合、考えられるルートの 1 つは次のとおりです。現在位置にマークが付いていますX。

```
Initially:
X=.|=.|.|=.|=|=.
.|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Down:
M=.|=.|.|=.|=|=.
X|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Right:
M=.|=.|.|=.|=|=.
.X=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Switch from using the torch to neither tool:
M=.|=.|.|=.|=|=.
.X=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Right 3:
M=.|=.|.|=.|=|=.
.|=|X|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Switch from using neither tool to the climbing gear:
M=.|=.|.|=.|=|=.
.|=|X|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Down 7:
M=.|=.|.|=.|=|=.
.|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..X==..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Right:
M=.|=.|.|=.|=|=.
.|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..=X=..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Down 3:
M=.|=.|.|=.|=|=.
.|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||.X.|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Right:
M=.|=.|.|=.|=|=.
.|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||..X|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Down:
M=.|=.|.|=.|=|=.
.|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.X..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Right 4:
M=.|=.|.|=.|=|=.
.|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===T===||
=|||...|==..|=.|
=.=|=.=..=X||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Up 2:
M=.|=.|.|=.|=|=.
.|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===X===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||

Switch from using the climbing gear to the torch:
M=.|=.|.|=.|=|=.
.|=|=|||..|.=...
.==|....||=..|==
=.|....|.==.|==.
=|..==...=.|==..
=||.=.=||=|=..|=
|.=.===|||..=..|
|..==||=.|==|===
.=..===..=|.|||.
.======|||=|=.|=
.===|=|===X===||
=|||...|==..|=.|
=.=|=.=..=.||==|
||=|=...|==.=|==
|=.=||===.|||===
||.|==.|.|.||=||
```

これは、目標(分) に到達する最速の方法として他のルートと結びついています45。この中では、21ツールの切り替えに数分 (各 7 分ずつ、3 回) が費やされ、残りの24分は移動に費やされます。

目標に到達するまでにかかる最小の時間は何分ですか?
