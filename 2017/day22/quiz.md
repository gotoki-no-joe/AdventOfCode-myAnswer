# 22日目：スポリフィカウイルス #
(soporific 眠くさせる, 催眠の)

診断システムから、ローカルグリッドコンピューティングクラスタがSporificaウイルスで汚染されていることが知らされます。
グリッドコンピューティングクラスタは、一見無限に見える計算ノードの2次元グリッドです。
各ノードはクリーンであるか、ウイルスに感染しています。

ノードの過負荷（ウイルスにとってノードが役に立たなくなる）やシステム管理者による検出を防ぐために、単一のウイルスキャリアのみがネットワーク内を移動し、移動時にノードに感染またはクリーニングします。
ウイルスキャリアは常にネットワーク内の単一のノード（現在のノード）に配置され、それが向いている方向を保持しています。

検出を回避するために、ウイルスキャリアはバーストで動作します。
各バーストで、それは目覚め、何か仕事をし、そして眠りに戻ります。
次の手順はすべて、バーストごとに1回ずつ順番に実行されます。

- 現在のノードが**感染**している場合は、右に曲がります。
それ以外の場合は、左に曲がります。
（回転はその場で行われます。現在のノードは変わりません。）
- 現在のノードが**クリーン**な場合は、感染されます。さもなくば、クリーンになります。
（これは、方向を変更するためにノードが調べられた後に行なわれます。）
- ウイルスキャリアは、向いている方向に1ノード前進します。

診断システムから、ノードの感染状態のマップ（パズル入力）も提供されました。
クリーンなノードは `.` と表示されています。
感染したノードは `#` と表示されています。
このマップは、グリッドの中心のみを示しています。
示されているノード以外にも多くのノードがありますが、現在感染しているノードはありません。

ウイルスキャリアは、マップの中央で上を向いた状態で始まります。

たとえば、次のようなマップが与えられたとします。

```
..#
#..
...
```

すると、無限グリッドの中央は次のようになります。
ここで、ウイルスキャリアの位置は `[ ]` とマークしています。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . # . . .
. . . #[.]. . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

ウイルスキャリアはクリーンなノード上にあるため、左に曲がり、ノードを感染させ、左に移動します。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . # . . .
. . .[#]# . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

ウイルスキャリアは感染ノードの上にあるため、右に曲がり、ノードをクリーンにし、上に移動します。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . .[.]. # . . .
. . . . # . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

4回連続して、ウイルスキャリアはクリーンなノードを見つけ、感染させ、左に曲がり、前進し、同じ場所に戻ったとき、やはり上を向いています。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . #[#]. # . . .
. . # # # . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

今、前と同じノード上で、そこが感染しているため、右に曲がり、ノードをクリーンにし、前進します。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . # .[.]# . . .
. . # # # . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

上記のアクションの完了で、全部で7バースト分の活動が起きました。
それらのうち、5つのバーストは感染を引き起こしました。

全部で70バーストした後、グリッドは次のようになり、ウイルスキャリアは上を向いています。

```
. . . . . # # . .
. . . . # . . # .
. . . # . . . . #
. . # . #[.]. . #
. . # . # . . # .
. . . . . # # . .
. . . . . . . . .
. . . . . . . . .
```

この時までに41バーストが感染を引き起こしました。
（ただし、これらのノードのほとんどはその後クリーンになっています。）

全部で10000バーストの活動の後、5587バーストは感染を引き起こしているでしょう。

あなたの実際のマップを考えて、10000バーストの活動の後、ノードを感染させたバーストの数はいくつですか？
（初めから感染していたノードは数えないでください。）
(?? Do not count nodes that begin infected. ??)

# パート2 #

感染したノードからウイルスを削除しようとすると、ウイルスは進化してその試みに抵抗します。

今や、ウィルスキャリアはクリーンなノードを感染させる前に、ノードを弱めて防御を無効にします。
感染したノードに遭遇した場合、代わりに、将来クリーンアップされるというフラグをノードに立てます。
つまり：

- クリーンなノードは弱められます。
- 弱められたノードは感染させられます。
- 感染したノードはフラグが立てられます。
- フラグが立てられたノードはクリーンになります。

すべてのノードは、常に上記の状態のいずれかになります。

ウイルスキャリアは引き続き同様の方法で動作しますが、アクションのバースト中に次のロジックを使用するようになりました。

- 現在のノードに基づいて、どちらの方向に曲がるかを決定します。
 - クリーンな場合は左に曲がります。
 - 弱められている場合は方向転換せず、同じ方向に移動し続けます。
 - 感染している場合は右に曲がります。
 - フラグが立てられている場合は、方向を反転し、来た方向に戻ります。
- 上述のように、現在のノードの状態を変更します。
- ウイルスキャリアは、向いている方向に1ノード前方に移動します。

同じマップ（やはり `.` をクリーンな、`#` を感染したの意味で用いて）から始めて、ウイルスキャリアはやはり中央から上向きで開始します。

前の例と同じ初期状態を使用して、弱体化を `W`、フラグを立てられているノードを `F` で表して、無限のグリッドの中央部は以下のようになる。やはりウイルスキャリアの位置は `[ ]` で印す。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . # . . .
. . . #[.]. . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

初期ノードは弱められたりフラグが付けられたりしていないため、これは以前と同じです。
ウイルスキャリアはクリーンなノード上にあるため、やはり左に曲がり、ノードを弱め、左に移動します。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . # . . .
. . .[#]W . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

ウイルスキャリアは感染したノード上にあるため、やはり右に曲がり、ノードにフラグを立てて上に移動します。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . .[.]. # . . .
. . . F W . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

このプロセスはさらに3回繰り返され、前にフラグが付けられたノードで終了し、右向きになります。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . W W . # . . .
. . W[F]W . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

フラグが立てられたノードを見つけると、向きを逆にし、ノードがクリーンアップされます。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . W W . # . . .
. .[W]. W . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

弱められたノードは、感染させられ、同じ方向に進みます。

```
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
. . W W . # . . .
.[.]# . W . . . .
. . . . . . . . .
. . . . . . . . .
. . . . . . . . .
```

最初の100バーストのうち、26が感染を起こします。
残念ながら、この進化したウイルスのもう1つの特徴は速度です。
最初の10000000バーストのうち、2511944で感染が発生します。

実際のマップを考えると、アクティビティの10000000バースト後、ノードに感染を起こすバーストの数はいくつですか？
（元から感染していたノードは数えないでください。）
(?? Do not count nodes that begin infected. ??)
