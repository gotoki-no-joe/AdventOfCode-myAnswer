# 22日目: 猿市場

あなたたちがジャングルの奥深くにテレポートされると、
[猿](../2022/day11.md)が歴史学者たちの装置を盗んでしまいます！
歴史学者たちが主任を探している間に、それを取り戻さなければなりません。

装置を盗んだ猿は、交換条件として途方もない数のバナナを要求しているようです。
あなたの唯一の選択肢は、猿交換市場でバナナを買うことです。

猿交換市場がどのように機能するのかはわかりませんが、歴史学者の一人が危機を察して助けに来てくれます。
どうやら、彼らはここの猿を研究していたことがあり、彼らの秘密を解読しているようです。

今日は、市場には**良い隠れ場所**を買いに来た猿がいっぱいいます。
幸運なことに、最近このジャングルで過ごした時間のおかげで、
売ることができる良い隠れ場所をあなたはたくさん知っています！
十分な隠れ場所を売れば、デバイスを買い戻すための十分なバナナを手に入れることができるでしょう。

市場では、買い手はランダムな価格を使っているようですが、実際には彼らの価格は単なる擬似乱数です！
彼らが価格を決める秘密を知っていれば、最適な売りどきを待つことができます。

秘密についての部分は文字通りです、と歴史学者は説明します。
バイヤーはそれぞれ、前の秘密の数から導き出された秘密の数の擬似乱数列を生成します。

特に、各バイヤーの**秘密**の数は、次の手順を経て、列の次の秘密の数が導かれます。

- **秘密の数に64を掛けた**結果を計算します。次に、この結果を秘密の数に**混ぜます**。最後に、秘密の番号を**剪定**します。
- **秘密の数を32で割った**結果を計算します。結果は最も近い整数に切り捨てます。
次に、この結果を秘密の数に**混ぜます**。最後に、秘密の数を**剪定**します。
- **秘密の数に2048を掛けた**結果を計算します。次に、この結果を秘密の数に**混ぜます**。最後に、秘密の数を**剪定**します。

上記の手順の各段階には、**混ぜる**ことと**剪定**が含まれます：

- 値を秘密の数に**混ぜる**には、与えられた値と秘密の数の[ビット単位XOR](https://ja.wikipedia.org/wiki/%E3%83%93%E3%83%83%E3%83%88%E6%BC%94%E7%AE%97#%E3%83%93%E3%83%83%E3%83%88%E3%82%B7%E3%83%95%E3%83%88)を計算します。
すると、秘密の数はその操作の結果になります。
（秘密の数が42で、15を秘密の数に**混ぜる**と、秘密の数は37になります。）
- 秘密の数を**剪定**するには、秘密の数を16777216で[割った余り](https://ja.wikipedia.org/wiki/%E5%89%B0%E4%BD%99%E6%BC%94%E7%AE%97)を計算します。
すると、秘密の数はその操作の結果になります。
（秘密の数が100000000で、秘密の数を**剪定**すると、秘密の数は16113920になります。）

この手順が完了すると、バイヤーは列の次の秘密の数を得ます。
バイヤーは、より多くの秘密の数を生成するために、この手順を必要なだけ繰り返すことができます。

したがって、あるバイヤーが秘密の数 123 を持っている場合、
そのバイヤーの次に続く10個の秘密の数は次のようになります：

```
15887950
16495136
527345
704524
1553684
12683156
11100544
12249484
7753432
5908254
```

各バイヤーは価格を選ぶ際に自分の秘密の数を使用するため、各バイヤーの秘密の数の列を予測できることが重要です。
幸いなことに、歴史学者の研究により、**各バイヤーの秘密の数の初期値**が明らかになりました（あなたのパズルの入力）。
例えば：

```
1
10
100
2024
```

このリストは、猿交換市場の異なる4人の秘密の隠れ場所バイヤーの初期の数の初期値です。
各バイヤーからの秘密の数をシミュレートできれば、彼らの将来の価格を全て予測できるようになります。

1日のうちに、バイヤーはそれぞれ2000の**新しい**秘密の数を生成する時間があります。
この例では、各バイヤーの秘密の数の初期値と、彼らが生成する2000番目の新しい秘密の数は次のとおりです。

|初期値|2000番め|
|--:|--:|
|1|8685429|
|10|4700978|
|100|15273692|
|2024|8667524|

各バイヤーについて2000番目の新しい秘密の数を足し合わせると、37327623になります。

各バイヤーについて、2000の新しい秘密の数の生成をシミュレートします。
各バイヤーにより生成された2000番目の秘密の数の合計はいくつですか？

# パート2

もちろん、秘密の数は各バイヤーが提示している価格ではありません！それはばかげています。
そうではなく、バイヤーが提示する**価格**は、それぞれの秘密の数の**一の位の数字**です。

したがって、バイヤーが秘密の数123から始めると、そのバイヤーの最初の10回の**価格**は次のようになります：

```
3 (123 の)
0 (15887950 の)
6 (16495136 の)
5 (以下同様)
4
4
6
4
4
2
```

この価格は、バイヤーがあなたの新しい隠れ場所に関する情報と引き換えに提供している**バナナ**の数です。
しかし、あなたはまだ[猿の言葉](../../2022/day21/quiz.md)を話せないので、バイヤーと直接交渉することはできません。
歴史学者は少し話せますが、交渉するには十分ではありません。
その代わりに、彼は別の猿にあなたの代わりに交渉を頼むことができます。

残念ながら、その猿は価格の**変動**を見て売るタイミングを決めることしかできません。
具体的には、その猿は**4つの連続した価格変動の特定の列**を探し、その列を見たらすぐに売却します。

したがって、バイヤーが秘密の数123から始まる場合、そのバイヤーの最初の10個の秘密の数、価格、
および対応する変動は次のようになります:

|秘密の数|価格|変動|
|--:|:--:|--:|
|123| 3| |
|15887950| 0|-3|
|16495136| 6|6|
|  527345| 5|-1|
|  704524| 4|-1|
| 1553684| 4|0|
|12683156| 6|2|
|11100544| 4|-2|
|12249484| 4|0|
| 7753432| 2|-2|

最初の価格には比較する前の価格がないため、対応する変動はありません。

この短い例では、最初の数個の価格の中で最高価格は6になるので、猿にその時に売るよう指示を出すと良いでしょう。
最初の6はわずか2回の変動の後に出現するため、その時に猿に売るよう指示することはできません。
しかし、2回目の6は変動 -1,-1,0,2 の後に出現します。
したがって、この変動の列を猿に与えれば、猿はその列を初めて見るまで待ち、
その後直ちに現在の価格で隠れ場所の情報を売り、6本のバナナを得ることができます。

各バイヤーは隠れ場所をひとつだけしか購入したくないので、隠れ場所が売れた後、猿は次のバイヤーに移ります。
もし猿がバイヤーから指示されたその価格変動の列を聞かなければ、猿は決して売らず、代わりに次のバイヤーに移動します。

さらに悪いことに、探すための価格変動の列は、猿に与えられるのは**一つだけ**です。
バイヤーごとに列を変更することはできません。

あなたはできるだけ多くのバナナが必要になるので、
**どの4つの価格変動の例が全体として最も多くのバナナを得る**ことができるかを決める必要があります。
各バイヤーは、秘密の数の初期値の後に2000の秘密の数を生成するので、
各バイヤーについて、あなたの列が出現する**2000の価格変動**があります。

各バイヤーの秘密の数の初期値が次のとおりだとします：

```
1
2
3
2024
```

猿に伝えることができる4つの価格変動の列はたくさんありますが、
これら4人のバイヤーに対して、最も多くのバナナを得られる列は -2,1,-1,3 です。
この列を使用すると、猿は次のように販売します：

- 秘密の数の初期値が1のバイヤーに対して、変動 -2,1,-1,3 は最初に価格が7のときに出現します
- 秘密の数の初期値が2のバイヤーに対して、変動 -2,1,-1,3 は最初に価格が7のときに出現します
- 秘密の数の初期値が3のバイヤーに対して、変動 -2,1,-1,3 は最初の2000回の変動の中には**出現しません**。
- 初期値が2024のバイヤーに対して、変動 -2,1,-1,3 は最初に価格が9のときに発生します。

したがって、猿に各バイヤーの価格が2下がり、次に1上がり、次に1下がり、最後に3上がった最初のときに
売るように頼むと、23（7 + 7 + 9）バナナを得ることができます！

全てのバイヤーの将来の価格でその変動の列を探すことで、合計で最も多くのバナナを得ることができる、
猿に伝えるべき最良の列を見つけてください。そうして得られる最も多くのバナナはどれだけですか？
