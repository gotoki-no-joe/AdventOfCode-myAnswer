# 9日目: 吊り橋

この吊り橋は、あなたが歩くと軋みます。
どれほど古いものなのか、あなたの体重を支えられるかどうかも怪しいです。

とはいえ、小人の体重を支えるぶんには大丈夫なようです。
橋は、あなたのはるか眼下の巨大な川によって切り開かれた峡谷にまたがっています。

あなたは慎重に足を踏み入れます。それにより、ロープは伸びてねじれます。
あなたは、ロープの物理をモデル化して気を紛らわせることにしました。
踏んではいけない場所を見つけることができるかもしれません。

両端に結び目があるロープを考えます。
これらの結び目は、ロープの**頭**と**尾**を示しています。
頭が尻尾から十分に離れると、尾は頭の方に引っ張られます。

[プランク長](https://ja.wikipedia.org/wiki/%E3%83%97%E3%83%A9%E3%83%B3%E3%82%AF%E9%95%B7)
に関する漠然とした推論により、2次元グリッド上の結び目の位置をモデル化できるはずです。
すると、頭結び目の**仮想的な一連の動き**（パズルの入力）に従うことで、
**尾**がどのように動くかを決定できます。

前述のプランク長により、ロープはきわめて短くする必要があります。
実際、頭(`H`)と尾(`T`)は**常に接触している**必要があります。
（角で接している場合と、重なり合っている場合も、接触していると見なします。）

```
....
.TH.
....

....
.H..
..T.
....

...
.H. (H は T に重なっている)
...
```

頭が尻尾から2歩上、下、左、右にある場合、尻尾もその方向に1歩移動して、十分に近い状態を保つ必要があります。

```
.....    .....    .....
.TH.. -> .T.H. -> ..TH.
.....    .....    .....

...    ...    ...
.T.    .T.    ...
.H. -> ... -> .T.
...    .H.    .H.
...    ...    ...
```

それ以外の場合、頭と尾が接しておらず、同じ行または列にない場合、尾は常に1ステップ斜めに移動して追いつきます。

```
.....    .....    .....
.....    ..H..    ..H..
..H.. -> ..... -> ..T..
.T...    .T...    .....
.....    .....    .....

.....    .....    .....
.....    .....    .....
..H.. -> ...H. -> ..TH.
.T...    .T...    .....
.....    .....    .....
```

頭が一連の動きに追従するときに、尾がどこに行くのかを理解する必要があります。
頭と尾の両方が同じ位置から始まり、重なり合っていると仮定します。

例えば：

```
R 4
U 4
L 3
D 1
R 4
D 1
L 5
R 2
```

この一連の動作により、頭が**右**に4歩移動し、次に4歩**上**に移動し、
次に3歩**左**に移動し、次に1歩**下**に移動します。
各ステップの後、ステップによって頭が尾に隣接していない場合は、尾の位置を更新する必要があります。
視覚的には、これらの動きは次のように表せます。
（`s`は開始位置を示す印で、参照点です。）

```
== 初期状態 ==

......
......
......
......
H.....  (H は T, s と重なっている)

== R 4 ==

......
......
......
......
TH....  (T は s と重なっている)

......
......
......
......
sTH...

......
......
......
......
s.TH..

......
......
......
......
s..TH.

== U 4 ==

......
......
......
....H.
s..T..

......
......
....H.
....T.
s.....

......
....H.
....T.
......
s.....

....H.
....T.
......
......
s.....

== L 3 ==

...H..
....T.
......
......
s.....

..HT..
......
......
......
s.....

.HT...
......
......
......
s.....

== D 1 ==

..T...
.H....
......
......
s.....

== R 4 ==

..T...
..H...
......
......
s.....

..T...
...H..
......
......
s.....

......
...TH.
......
......
s.....

......
....TH
......
......
s.....

== D 1 ==

......
....T.
.....H
......
s.....

== L 5 ==

......
....T.
....H.
......
s.....

......
....T.
...H..
......
s.....

......
......
..HT..
......
s.....

......
......
.HT...
......
s.....

......
......
HT....
......
s.....

== R 2 ==

......
......
.H....  (H は T と重なっている)
......
s.....

......
......
.TH...
......
s.....
```

ロープのシミュレーションを実施すると、
**尾が少なくとも一度訪れた**全ての位置を数えることができます。
この図では、`s`は今回も開始位置（これは尾も訪問している）、
`#`は尾が訪問したその他の位置を印しています。

```
..##..
...##.
.####.
....#.
s###..
```

したがって、13箇所が、尾が少なくとも一度訪れた位置です。

完全に架空の一連の動作をシミュレーションしてください。
**ロープの尾が少なくとも一度訪れる位置は何か所ですか？**

<!--
<details><summary>解説</summary><div>

- 頭は4近傍で1ずつだけ移動する。
- 尾は頭と横軸縦軸ともに差が1までなら許容される。（動かない）
- いずれかの軸はずれておらず、もう一方の軸だけ2ずれた場合、そのずれを1修正して4近傍に移動する。
- 両方の軸がずれた場合、両方について補正をかける。

この規則に合うように、頭の位置と尾の位置から、尾の新しい位置を求める計算を定義する。

```haskell
follow (tx,ty) (hx,hy)
  | abs dx <= 1 && abs dy <= 1 = (tx,ty)
  | dx == 0 = (tx, ty1)
  | dy == 0 = (tx1, ty)
  | otherwise = (tx1, ty1)
  where
    dx = hx - tx
    dy = hy - ty
    tx1 = tx + signum dx
    ty1 = ty + signum dy
```

あとは、ファイルを読み込み、頭の位置の系列を作る
尾を追尾させ、その座標を集合に入れて、要素数を数える。

```haskell
import qualified Data.Set as S

main1 = body1 "input.txt"
test1 = body1 "test.txt"

body1 fn = readFile fn >>= print . compute1 . lines

compute1 :: [String] -> Int
compute1 ls = S.size $ S.fromList tailPoss
  where
    headPoss =
      scanl add (0,0) $
      concatMap ((\[d,n] -> replicate (read n) (delta $ head d)) . words) ls
    tailPoss = scanl follow (0,0) headPoss

add (x,y) (z,w) = (x+z, y+w)

delta 'U' = (0,-1)
delta 'D' = (0, 1)
delta 'L' = (-1,0)
delta 'R' = ( 1,0)
```

</div></details>
-->

# パート2

ロープがプツリと切れる！
突然、川はあなたがこれまでに見たことのあるよりもはるかに近づいています。
橋はまだそこにありますが、千切れたロープの一部は、空中を落下しつつあるあなたに向かって鞭打っています!

ロープの動きが速すぎて掴めません。
叩かれるのを避けるために体を反らせる方法を選択するのに数秒しかありません。
幸いなことに、シミュレーションを拡張して、より長いロープに対応できます。

結び目が2つではなく、**10**個の結び目で構成されるロープをシミュレーションする必要があります。
結び目のひとつはやはりロープの頭で、一連の動きに従って動きます。
ロープの続きにある結び目はそれぞれ、前と同じ規則を使用して、その直前の結び目に従います。

上記の例と同じ一連の動きを使用しますが、
結び目を`H`,`1`,`2`,…,`9`と印すと、動きは次のようになります。

```
== 初期状態 ==

......
......
......
......
H.....  (H は 1, 2, 3, 4, 5, 6, 7, 8, 9, s と重なっている)

== R 4 ==

......
......
......
......
1H....  (1 は 2, 3, 4, 5, 6, 7, 8, 9, s と重なっている)

......
......
......
......
21H...  (2 は 3, 4, 5, 6, 7, 8, 9, s と重なっている)

......
......
......
......
321H..  (3 は 4, 5, 6, 7, 8, 9, s と重なっている)

......
......
......
......
4321H.  (4 は 5, 6, 7, 8, 9, s と重なっている)

== U 4 ==

......
......
......
....H.
4321..  (4 は 5, 6, 7, 8, 9, s と重なっている)

......
......
....H.
.4321.
5.....  (5 は 6, 7, 8, 9, s と重なっている)

......
....H.
....1.
.432..
5.....  (5 は 6, 7, 8, 9, s と重なっている)

....H.
....1.
..432.
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

== L 3 ==

...H..
....1.
..432.
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

..H1..
...2..
..43..
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

.H1...
...2..
..43..
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

== D 1 ==

..1...
.H.2..
..43..
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

== R 4 ==

..1...
..H2..
..43..
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

..1...
...H..  (H は 2 と重なっている)
..43..
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

......
...1H.  (1 は 2 と重なっている)
..43..
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

......
...21H
..43..
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

== D 1 ==

......
...21.
..43.H
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

== L 5 ==

......
...21.
..43H.
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

......
...21.
..4H..  (H は 3 と重なっている)
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

......
...2..
..H1..  (H は 4と、1 は 3 と重なっている)
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

......
...2..
.H13..  (1 は 4 と重なっている)
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

......
......
H123..  (2 は 4 と重なっている)
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

== R 2 ==

......
......
.H23..  (H は 1 と、2 は 4 と重なっている)
.5....
6.....  (6 は 7, 8, 9, s と重なっている)

......
......
.1H3..  (H は 2, 4 と重なっている)
.5....
6.....  (6 は 7, 8, 9, s と重なっている)
```

さて、新たな尾`9`が訪れる位置を追跡する必要があります。
この例では、尻尾は決して動かないため、1箇所を訪問するだけです。
ただし**注意してください**。
以前よりも多くの種類の動きが可能になるため、
あなたのシミュレーションによるロープと上のロープを視覚的に比較することをお勧めします。

より大きな例を次に示します。

```
R 5
U 8
L 8
D 3
R 17
D 10
L 25
U 20
```

これらの動作は次のようになります (個々のステップは示されていません)。

```
== 初期状態 ==

..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
...........H..............  (H は 1, 2, 3, 4, 5, 6, 7, 8, 9, s と重なっている)
..........................
..........................
..........................
..........................
..........................

== R 5 ==

..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
...........54321H.........  (5 は 6, 7, 8, 9, s と重なっている)
..........................
..........................
..........................
..........................
..........................

== U 8 ==

..........................
..........................
..........................
..........................
..........................
..........................
..........................
................H.........
................1.........
................2.........
................3.........
...............54.........
..............6...........
.............7............
............8.............
...........9..............  (9 は s と重なっている)
..........................
..........................
..........................
..........................
..........................

== L 8 ==

..........................
..........................
..........................
..........................
..........................
..........................
..........................
........H1234.............
............5.............
............6.............
............7.............
............8.............
............9.............
..........................
..........................
...........s..............
..........................
..........................
..........................
..........................
..........................

== D 3 ==

..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
.........2345.............
........1...6.............
........H...7.............
............8.............
............9.............
..........................
..........................
...........s..............
..........................
..........................
..........................
..........................
..........................

== R 17 ==

..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
................987654321H
..........................
..........................
..........................
..........................
...........s..............
..........................
..........................
..........................
..........................
..........................

== D 10 ==

..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
...........s.........98765
.........................4
.........................3
.........................2
.........................1
.........................H

== L 25 ==

..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
...........s..............
..........................
..........................
..........................
..........................
H123456789................

== U 20 ==

H.........................
1.........................
2.........................
3.........................
4.........................
5.........................
6.........................
7.........................
8.........................
9.........................
..........................
..........................
..........................
..........................
..........................
...........s..............
..........................
..........................
..........................
..........................
..........................
```

こうして、尾(`9`)は36箇所（`s`を含む）を少なくとも一度訪問します。

```
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
..........................
#.........................
#.............###.........
#............#...#........
.#..........#.....#.......
..#..........#.....#......
...#........#.......#.....
....#......s.........#....
.....#..............#.....
......#............#......
.......#..........#.......
........#........#........
.........########.........
```

結び目の10個ある長いロープの一連の動作をシミュレーションします。
**ロープの尾が少なくとも一度訪れる位置は何か所ですか？**

<!--
<details><summary>解説</summary><div>

「前の結び目の位置を追尾した列を作る」という計算を9回重ねて実行するように変更する。

```haskell
main2 = body2 "input.txt"
test2 = body2 "test.txt"
test3 = body2 "test2.txt"

body2 fn = readFile fn >>= print . S.size . compute2 . lines

compute2 :: [String] -> S.Set (Int,Int)
compute2 ls = S.fromList tailPoss
  where
    headPoss =
      scanl add (0,0) $
      concatMap ((\[d,n] -> replicate (read n) (delta $ head d)) . words) ls
    knot xys = scanl follow (0,0) xys
    tailPoss = iterate knot headPoss !! 9
```

</div></details>
-->
