# 25日目：雪よ降れ

メリークリスマス！
サンタはお天気制御装置を起動しています。
あなたは結局[ホワイトクリスマス](./day1.md)を得られそうです。

お天気制御装置がビービーと鳴りました！
装置のコンソールには、
取扱説明書のコードを入力するように求めるコピー防止メッセージが出ています。
どうやら、あなたがそのコードを与えない限り、それは実行を拒否するようです。
別に問題はありません。あなたはマニュアルからコードを調べるでしょう…

「ホー、ホー、ホー」サンタは大声で熟考します。
「マニュアルを見つけ出せる気がしない。」

製造元のサポート電話番号を調べて、電話をかけます。
良いこともあります - その49番目のスターはそれ自体で稼ぐことはできませんでした。
(???)

「ああ、その機械はかなり古いです！」と彼らは言います。
「そのモデルは6分前にサポートを終了しました。
そして、私たちはすべてのマニュアルをシュレッダーにかけたばかりです。
ただし、コード生成アルゴリズムを見つけることができると思います。」

あなたを20分間保留にした
（あなたの電話は彼らにとって非常に重要で、繰り返し思い出させてくれました）(???)
後、
彼らはついにコードシステムがどのように機能するかを覚えているエンジニアを見つけました。

コードは、左上隅から始まる無限の紙に印刷されています。
コードは対角線で埋められます。
空の最初のマスを1つもつ最初の行から始まり、コードは斜めに上と右に向かって埋められます。
このプロセスは、
[無限の紙が覆われる](https://ja.wikipedia.org/wiki/カントールの対角線論法)
まで繰り返されます。
よって、最初のいくつかのコードは次の順序で埋められます。

~~~
   | 1   2   3   4   5   6
---+---+---+---+---+---+---+
 1 |  1   3   6  10  15  21
 2 |  2   5   9  14  20
 3 |  4   8  13  19
 4 |  7  12  18
 5 | 11  17
 6 | 16
~~~

たとえば、12番目のコードは4行2列に書き込まれます。
15番目のコードは1行5列に書き込まれます。

電話の向こうの声は、続けてコードが実際にどのように生成されるかを説明します。
最初のコードは`20151125`です。
その後、各コードは、前のコードに`252533`を乗算してから、
その値を`33554393`で除算した余りとして生成されます。

したがって、2番目のコード（2行1列にくる）を見つけるには、
前の値`20151125`から始めます。
それに`252533`を掛けて`5088824049625`を得ます。
そしてそれを`33554393`で割ると余りが`31916031`となります。
この余りが2番目のコードです。

「ああ！」と声がします。
「マニュアルにコードのページがあるのを見落としていたようです。読んでみましょう。」
あなたは彼の読み上げる番号を書き留めます。

~~~
   |    1         2         3         4         5         6
---+---------+---------+---------+---------+---------+---------+
 1 | 20151125  18749137  17289845  30943339  10071777  33511524
 2 | 31916031  21629792  16929656   7726640  15514188   4041754
 3 | 16080970   8057251   1601130   7981243  11661866  16474243
 4 | 24592653  32451966  21345942   9380097  10600672  31527494
 5 |    77061  17552253  28094349   6899651   9250759  31663883
 6 | 33071741   6796745  25397450  24659492   1534922  27995004
~~~

「さて、覚えておいて」声は続きます。
「それは最初のいくつかの数字のすべてでさえありません。
例えば、あなたは行6列2の前に来るはずの行7列1の内容がありません。
でもこれだけ判っていれば充分で…
ああ、昼食の時間だよ、さようなら」通話が切断されます。

サンタはオロオロしています。
あなたのパズル入力には、装置のコンソールにあるメッセージが含まれています。
**あなたは装置にどんなコードを与えますか？**

<details><summary>解説</summary><div>

行 `theRow` 列 `theCol` の値を聞かれている。
まず、それが数列の何個目の値かを、ひとつめの表を見ながら考える。

斜めの列の \\(K\\) 本めを考える。
それぞれの長さは順に \\(1,2,3,\dots\\) なので、その末尾の数は \\(1 + 2 + \dots + K = K (K + 1) / 2\\) となる。
またそれは行\\(1\\)列\\(K\\)の位置にある。

行 \\(r\\) 列\\(c\\) のマスは、そこから右上マスに\\(r-1\\)回移動した先にある、行\\(1\\)列\\(c+r-1\\)と同じ斜め列に属する。つまり \\(K = c + r - 1\\) 行に属する。
そのひとつ手前、\\(K-1\\)本めの斜め列の最後のマスの番号は \\((K-1)K/2\\) で、
行\\(r\\)列\\(c\\)のマスはそれからさらに\\(c\\)マス先にあるので \\((c+r-2)(c+r-1)/2 + c\\) 番である。

```haskell
index r c = div ((c + r - 2) * (c + r - 1)) 2 + c
```

次に、数列の `index theRow theCol` 番めの値を求める。
第1項は `20151125`, 直前の項から次の項を得る漸化式から列を作る。

```haskell
theSeed = 20151125
theMag  = 252533
modBase = 33554393

step :: Int -> Int
step x = mod (x * theMag) modBase

theSeq = 0 : iterate step theSeed

part1 = theSeq (index theRow theCol)
```

しかし計算が終わらない。繰り返し回数が大きすぎる。

ここで、数列の定義をもう一度見てみる。

\\(a_1 = 20151125\\)  
\\(a_{i+1} = a_i \times 252533 \bmod 33554393\\)

剰余で考えればよいので、これはモジュロ演算で

\\(a_i \equiv 20151125 \times 252533^{i-1} \bmod 33554393\\)

と等しい。このべき乗は、2進数に基づいて高速に計算する定番の方法がある。

```haskell
-- @gotoki_no_joe
powerish mul i a b = foldl' mul i [p | (True, p) <- zip bs ps]
  where
    bs = map odd $ takeWhile (0 <) $ iterate (flip div 2) b
    ps = iterate (\x -> mul x x) a

part1a = powerish mul theSeed theMag $ pred $ index theRow theCol

mul x y = mod (x * y) modBase
```

</div></details>


# パート2 #

装置は活気を取り戻し、その後また沈黙します。
ビープ音がします。
「燃料不足」とコンソールに表示されます。
「先へ進むには**50個のスター**が必要です。**スターがひとつ**利用可能です。」

…「スターがひとつ利用可能？」あなたは燃料タンクを点検します。
確かに、唯一のスターがその友人を待って、一番下に座っています。
49個は自分で用意する必要があるようです。

**スターが足らない場合**  
あなたは装置を起動するのに十分な星がありません。さらに(?)個必要です。

**スターが49揃った場合**  
あなたはお天気制御装置を起動するのに充分なスターを持っています。

あなたはお天気制御装置に50個のスターを充填します。それは息を吹き返しました！

**雪が降り始めます。**
