# 15日目: レンズのコレクション

新たに焦点を合わせたパラボラ反射板は、集められた全ての光を、さらに別の山、つまり溶岩島最大の山の側面にある点に送ります。
山に近づくと、山腹に埋め込まれた大きな施設の壁に光が集まっていることがわかります。

「溶岩製造施設」と書かれた大きな看板の下に扉があるのを見つけます。
そしてその隣には「危険 ー この先は個人用保護具が必要です」と書かれた小さな標識があります。

中に足を踏み入れるとすぐに、ゴーグルとぶかぶかのキャップ型ヘルメットを付けた、
ややパニック気味のトナカイが出迎えてくれます。
トナカイは、ゴーグルとヘルメットのある棚にあなたを案内します（あなたは急いで大きさの合うものを選びます）、
さらに施設の中へ進みます。
ある箇所で、不鮮明な鼻の跡が付いた“PUSH FOR HELP”というラベルのあるボタンを通り過ぎます。
あの勢いで[投石器](../day1/quiz.md)に装填されたことに合点が行きました。

さらに多くの警告標識に囲まれた最後のドアを通り抜けて、
外からの光が全て集まる場所に違いない部屋に入りました。
光をさらに集中させるために利用できるさまざまなレンズの品揃えに感心していると、
トナカイが「初期化マニュアル」というタイトルの本を持ってきます。

「こんにちは！」と本は元気よく始まります。
トナカイが心配そうに肩越しに本を読んでいることにはお構いなしです。
「この手順により、意図しないものを燃やしたり溶かしたりすることなく、溶岩製造施設を作動させることができます！」

「始める前に、Holiday ASCII String Helper (HASH)アルゴリズム（付録1A）を使用する準備をしてください。」
付録1Aを開きます。トナカイは興味深そうに身を寄せてきます。

HASHアルゴリズムは、任意の文字列を0から255の範囲の単一の**数値**に変換する方法です。
文字列に対してHASHアルゴリズムを実行するには、**現在の値**を0で開始します。
次に、文字列の先頭から各文字に対して次のように処理します：

- 文字列の現在の文字のASCIIコードを求めます。
- そのASCIIコードの分だけ**現在の値**を増やします。
- **現在の値**を、それに17を掛けた値にします。
- **現在の値**を、それを256で割った余りにします。

文字列内の各文字に対してこれらの手順を順番に実行した後の、**現在の値**がHASHアルゴリズムの出力になります。

よって、文字列 `HASH` に対してHASHアルゴリズムを実行した結果を得るには：

- **現在の値**は0から始まります。
- 最初の文字は `H` です。そのASCIIコードは72です。
- **現在の値**を72まで増加させます。
- **現在の値**は17を掛けられ1224になります。
- **現在の値**は200になります（1224を256で割った余り）。
- 次の文字は `A` です。そのASCIIコードは65です。
- **現在の値**を265まで増加させます。
- **現在の値**に17を掛けて4505とします。
- **現在の値**は153になります（4505を256で割った余り）。
- 次の文字は `S` です。そのASCIIコードは83です。
- **現在の値**を236まで増加させます。
- **現在の値**に17を掛けて4012とします。
- **現在の値**は172になります（4012を256で割った余り）。
- 次の文字は `H` です。そのASCIIコードは72です。
- **現在の値**を244まで増加させます。
- **現在の値**に17を掛けて4148とします。
- **現在の値**は52になります（4148を256で割った余り）。

文字列 `HASH` に対してHASHアルゴリズムを実行した結果は**52**になります。

**初期化シーケンス**（あなたのパズル入力）は、溶岩製造施設を始動するためのステップのカンマ区切りのリストです。
初期化シーケンスを解析するときは**改行文字を無視**してください。
HASHアルゴリズムが正しく動作していることを確認するために、
本書では、初期化シーケンスの各ステップに対してHASHアルゴリズムを実行した結果の合計を示します。

例えば：

```
rn=1,cm-,qp=3,cm=2,qp-,pc=4,ot=9,ab=5,pc-,pc=6,ot=7
```

この初期化シーケンスには11の個々のステップが指定されています。
各ステップに対してHASHアルゴリズムを実行した結果は次のようになります。

- `rn=1` は**30**になります。
- `cm-` は**253**になります。
- `qp=3` は**97**になります。
- `cm=2` は**47**になります。
- `qp-` は**14**になります。
- `pc=4` は**180**になります。
- `ot=9` は**9**になります。
- `ab=5` は**197**になります。
- `pc-` は**48**になります。
- `pc=6` は**214**になります。
- `ot=7` は**231**になります。

この例では、これらの結果の合計は**1320**です。
残念なことに、トナカイが確認用の結果値が記載されたページを盗んで、現在それを持って施設内を興奮して走り回っています。

初期化シーケンスの各ステップに対してHASHアルゴリズムを実行します。
**結果の合計はいくらですか？**
（初期化シーケンスは長い1行です。コピー&ペーストで貼り付ける場合は注意してください。）

# パート2

トナカイを説得してページを持ってこさせます。
そのページにより、あなたのHASHアルゴリズムが正しく機能していることが確認されました。

マニュアルは続いて、0から255までの番号が付けられた一連の256個の**箱**について説明します。
箱は、施設内に光が入る位置から一列に配置されています。
箱には穴があり、光はひとつの箱から次の箱へと一直線に通り抜けます。

```
光      箱       箱              箱
      +-----+  +-----+         +-----+
Light | Box |  | Box |   ...   | Box |
----------------------------------------->
      |  0  |  |  1  |   ...   | 255 |
      +-----+  +-----+         +-----+
```

それぞれの箱の内側には、**レンズを入れる枠**が複数あり、箱を通過する光の焦点を合わせるためにレンズを正しい位置に保ちます。
それぞれの箱の側面には蓋があり、必要に応じてレンズを挿入または取り外しできるように開きます。

箱の列と平行に延びる壁に沿って、**焦点距離**ごとに整理されたレンズの大きなコレクションがあります。
焦点距離は1から9の範囲です。
トナカイは、小型の携帯式ラベルプリンタも持ってきてくれます。

マニュアルには続いて、初期化シーケンスの各ステップの実行方法を説明します。
この手順は Holiday ASCII String Helper Manual Arrangement Procedure、略して**HASHMAP**と呼ばれます。

各ステップは、ステップが扱うレンズの**ラベル**を示す一連の文字で始まります。
ラベルに対してHASHアルゴリズムを実行した結果は、そのステップの正しい箱を示します。

ラベルの直後には、実行する**操作**を示す文字が続きます。等号 (`=`) またはダッシュ (`-`) です。。

操作文字が**ダッシュ** (`-`) の場合は、該当する箱に移動して、
指定されたラベルのレンズが箱に入っている場合は、それを取り除きます。
そして、残りのレンズを順序を変えずにボックス内でできるだけ前方に移動し、
指定されたレンズを取り外してできた空きを埋めます。
（箱に指定されたラベルが付いたレンズがない場合は、何も起こりません。）

操作演算文字が**等号** (`=`) の場合、その後に数字が続きます。
この数は、対応する箱に入れる必要があるレンズの**焦点距離**を示します。
必ず、後で見つけられるように、ラベルプリンタを使用して、手順の最初に指定したラベルをレンズに記してください。
次の2つの状況が考えられます：

- 同じラベルの付いたレンズが箱の中にすでにある場合は、新しいレンズと**古いレンズを交換**します。
古いレンズを取り外し、新しいレンズをその位置に置き、箱内の他のレンズは動かしません。
- 同じラベルの付いたレンズが箱の中に**ない**場合は、
そのレンズを、既に入っているレンズ列の直後に追加します。
このとき、他のレンズを動かさないでください。
箱の中にレンズが入っていない場合は、新しいレンズが箱の先頭にきます。

上記の初期化シーケンス例の各ステップ後のそれぞれの箱の内容は次のとおりです：

```
"rn=1" の後：
箱 0: [rn 1]

"cm-" の後：
箱 0: [rn 1]

"qp=3" の後：
箱 0: [rn 1]
箱 1: [qp 3]

"cm=2" の後：
箱 0: [rn 1] [cm 2]
箱 1: [qp 3]

"qp-" の後：
箱 0: [rn 1] [cm 2]

"pc=4" の後：
箱 0: [rn 1] [cm 2]
箱 3: [pc 4]

"ot=9" の後：
箱 0: [rn 1] [cm 2]
箱 3: [pc 4] [ot 9]

"ab=5" の後：
箱 0: [rn 1] [cm 2]
箱 3: [pc 4] [ot 9] [ab 5]

"pc-" の後：
箱 0: [rn 1] [cm 2]
箱 3: [ot 9] [ab 5]

"pc=6" の後：
箱 0: [rn 1] [cm 2]
箱 3: [ot 9] [ab 5] [pc 6]

"ot=7" の後：
箱 0: [rn 1] [cm 2]
箱 3: [ot 7] [ab 5] [pc 6]
```

256個の箱すべてが常に存在します。ここにはレンズが入っている箱のみを示しています。
箱の中については、レンズが前から後ろにリストされています。
各レンズは、角括弧内にそのラベルと焦点距離を示しています。

全てのレンズが正しく取り付けられていることを確認するには、
全てのレンズの**集束力**を合計します。
単一レンズの集束力は、次の要素を掛け合わせた結果です。

- 注目しているレンズの入っている箱の番号に1を加えた値
- 箱の中のレンズの枠番号：1番目のレンズの場合は1、2番目のレンズの場合は2、など
- レンズの焦点距離

上記の例の終了時点で、各レンズの集束力は次のようになります：

- `rn`: 1 (箱 0) × 1 (枠1) × 1 (焦点距離) = **1**
- `cm`: 1 (箱 0) × 2 (枠2) × 2 (焦点距離) = **4**
- `ot`: 4 (箱 3) × 1 (枠1) × 7 (焦点距離) = **28**
- `ab`: 4 (箱 3) × 2 (枠2) × 5 (焦点距離) = **40**
- `pc`: 4 (箱 3) × 3 (枠3) × 6 (焦点距離) = **72**

よって、上の例では、集束力の合計は**145**になります。

ヘルメットをかぶった狂信的すぎるトナカイの助けを借りて、初期化シーケンスを行います。
**結果として得られるレンズ構成の集束力はいくつですか？**
